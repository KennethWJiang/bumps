

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refl1d.snsdata &mdash; Refl1D v0.6.19 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku-site.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Refl1D v0.6.19 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>Refl1D v0.6.19 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.snsdata</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for refl1d.snsdata</h1><div class="highlight"><pre>
<span class="c"># This program is in the public domain</span>
<span class="c"># Author: Paul Kienzle</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SNS data loaders</span>

<span class="sd">The following instruments are defined::</span>

<span class="sd">    Liquids, Magnetic</span>

<span class="sd">These are :class:`resolution.Pulsed` classes tuned with</span>
<span class="sd">default instrument parameters and loaders for reduced SNS data.</span>
<span class="sd">See :mod:`resolution` for details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">.instrument</span> <span class="kn">import</span> <span class="n">Pulsed</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">resolution</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.probe</span> <span class="kn">import</span> <span class="n">make_probe</span>

<span class="c">## Estimated intensity vs. wavelength for liquids reflectometer</span>
<span class="n">LIQUIDS_FEATHER</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
  <span class="p">(</span><span class="mf">2.02555</span><span class="p">,</span><span class="mf">20.6369</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.29927</span><span class="p">,</span><span class="mf">23.6943</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.57299</span><span class="p">,</span><span class="mf">23.6943</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.87409</span><span class="p">,</span><span class="mf">21.1146</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">3.22993</span><span class="p">,</span><span class="mf">15.5732</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">3.58577</span><span class="p">,</span><span class="mf">12.8981</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">4.07847</span><span class="p">,</span><span class="mf">9.4586</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">4.5438</span><span class="p">,</span><span class="mf">6.59236</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">5.11861</span><span class="p">,</span><span class="mf">4.68153</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">5.7208</span><span class="p">,</span><span class="mf">3.05732</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">6.37774</span><span class="p">,</span><span class="mf">1.91083</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">7.19891</span><span class="p">,</span><span class="mf">1.24204</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">8.04745</span><span class="p">,</span><span class="mf">0.955414</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">9.06022</span><span class="p">,</span><span class="mf">0.573248</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">10.1825</span><span class="p">,</span><span class="mf">0.477707</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">11.4142</span><span class="p">,</span><span class="mf">0.382166</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">12.8102</span><span class="p">,</span><span class="mf">0.191083</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">14.3431</span><span class="p">,</span><span class="mf">0.286624</span><span class="p">),</span>
<span class="p">])</span><span class="o">.</span><span class="n">T</span>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a probe for SNS data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">instrument</span><span class="o">=</span><span class="n">Pulsed</span><span class="p">()</span>
    <span class="n">header</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="n">parse_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="c"># calling parameters override what&#39;s in the file.</span>
    <span class="c">#print &quot;\n&quot;.join(k+&quot;:&quot;+str(v) for k,v in header.items())</span>
    <span class="c"># Guess what kind of data we have</span>
    <span class="k">if</span> <span class="n">has_columns</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="s">&#39;dQ&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="s">&#39;dR&#39;</span><span class="p">,</span><span class="s">&#39;L&#39;</span><span class="p">)):</span>
        <span class="n">probe</span> <span class="o">=</span> <span class="n">QRL_to_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">has_columns</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;time_of_flight&#39;</span><span class="p">,</span><span class="s">&#39;data&#39;</span><span class="p">,</span><span class="s">&#39;Sigma&#39;</span><span class="p">)):</span>
        <span class="n">probe</span> <span class="o">=</span> <span class="n">TOF_to_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Unknown columns: &quot;</span><span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;columns&#39;</span><span class="p">]))</span>
    <span class="n">probe</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
    <span class="n">probe</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span>
    <span class="n">probe</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;instrument&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">probe</span>
</div>
<div class="viewcode-block" id="has_columns"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.has_columns">[docs]</a><span class="k">def</span> <span class="nf">has_columns</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;columns&#39;</span><span class="p">])</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">all</span><span class="p">(</span><span class="n">ci</span><span class="o">==</span><span class="n">si</span> <span class="k">for</span> <span class="n">ci</span><span class="p">,</span><span class="n">si</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;columns&#39;</span><span class="p">],</span><span class="n">v</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="QRL_to_data"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.QRL_to_data">[docs]</a><span class="k">def</span> <span class="nf">QRL_to_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert data to T,L,R</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">dL</span> <span class="o">=</span> <span class="n">resolution</span><span class="o">.</span><span class="n">binwidths</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;angle&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s">&#39;slits_at_Tlo&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;angle&#39;</span><span class="p">,</span><span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
        <span class="n">probe</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">probe</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">),</span>
                                 <span class="o">**</span><span class="n">header</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">T</span><span class="p">,</span><span class="n">dT</span> <span class="o">=</span> <span class="n">resolution</span><span class="o">.</span><span class="n">dQdL2dT</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dQ</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">L</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dL</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="n">probe</span> <span class="o">=</span> <span class="n">make_probe</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="o">=</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">),</span>
                           <span class="o">**</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probe</span>
</div>
<div class="viewcode-block" id="TOF_to_data"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.TOF_to_data">[docs]</a><span class="k">def</span> <span class="nf">TOF_to_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert TOF data to neutron probe.</span>

<span class="sd">    Wavelength is set from the average of the times at the edges of the</span>
<span class="sd">    bins, not the average of the wavelengths.  Wavelength resolution is</span>
<span class="sd">    set assuming the wavelength at the edges of the bins defines the</span>
<span class="sd">    full width at half maximum.</span>

<span class="sd">    The correct answer is to look at the wavelength distribution within</span>
<span class="sd">    the bin including effects of pulse width and intensity as a function</span>
<span class="sd">    wavelength and use that distribution, or a gaussian approximation</span>
<span class="sd">    thereof, when computing the resolution effects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TOF</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">dR</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">Ledge</span> <span class="o">=</span> <span class="n">resolution</span><span class="o">.</span><span class="n">TOF2L</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">d_moderator</span><span class="p">,</span> <span class="n">TOF</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">resolution</span><span class="o">.</span><span class="n">TOF2L</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">d_moderator</span><span class="p">,</span> <span class="p">(</span><span class="n">TOF</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="n">TOF</span><span class="p">[</span><span class="mf">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2</span><span class="p">)</span>
    <span class="n">dL</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ledge</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span><span class="o">-</span><span class="n">Ledge</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.35</span>   <span class="c"># FWHM is 2.35 sigma</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">dR</span> <span class="o">=</span> <span class="n">dR</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">min_time</span><span class="p">,</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;TOF_range&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="o">.</span><span class="n">TOF_range</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&amp;</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dR</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">TOF</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">min_time</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">TOF</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span><span class="o">&lt;=</span><span class="n">max_time</span><span class="p">)</span>
    <span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">]</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;angle&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">))],</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">resolution</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>
    <span class="n">probe</span> <span class="o">=</span> <span class="n">make_probe</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="o">=</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">),</span><span class="o">**</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">probe</span>
</div>
<div class="viewcode-block" id="parse_file"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.parse_file">[docs]</a><span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse SNS reduced data, returning *header* and *data*.</span>

<span class="sd">    *header* dictionary of fields such as &#39;data&#39;, &#39;title&#39;, &#39;instrument&#39;</span>
<span class="sd">    *data* 2D array of data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_header</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># guess instrument from file name</span>
    <span class="n">original_file</span> <span class="o">=</span> <span class="n">raw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">,</span><span class="s">&#39;unknown&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;REF_L&#39;</span> <span class="ow">in</span> <span class="n">original_file</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="s">&#39;Liquids&#39;</span>
    <span class="k">elif</span> <span class="s">&#39;REF_M&#39;</span> <span class="ow">in</span> <span class="n">original_file</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="s">&#39;Magnetic&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="s">&#39;unknown&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_file</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;radiation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;neutron&#39;</span>

    <span class="c"># Plug in default instrument values for slits</span>
    <span class="k">if</span> <span class="s">&#39;instrument&#39;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;instrument&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">INSTRUMENTS</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">INSTRUMENTS</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;instrument&#39;</span><span class="p">]]</span>
        <span class="n">header</span><span class="p">[</span><span class="s">&#39;d_s1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">d_s1</span>
        <span class="n">header</span><span class="p">[</span><span class="s">&#39;d_s2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">d_s2</span>

    <span class="c"># Date-time field for the file</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># Column names and units</span>
    <span class="n">columnpat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?P&lt;name&gt;\w+)[(](?P&lt;units&gt;[^)]*)[)]&#39;</span><span class="p">)</span>
    <span class="n">columns</span><span class="p">,</span><span class="n">units</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">columnpat</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">raw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)))</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

    <span class="c"># extra information like title, angle, etc.</span>
    <span class="n">commentpat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?P&lt;name&gt;.*)\s*:\s*(?P&lt;value&gt;.*)\s*\n&#39;</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">commentpat</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">raw_header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)))</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Title&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Notes&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># parse values of the form &quot;Long Name: (value, &#39;units&#39;)&quot; in comments</span>
    <span class="n">valuepat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;[(]\s*(?P&lt;value&gt;.*)\s*,\s*&#39;(?P&lt;units&gt;.*)&#39;\s*[)]&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">parse_value</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">valuepat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]),</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;units&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;Detector Angle&#39;</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
        <span class="n">header</span><span class="p">[</span><span class="s">&#39;angle&#39;</span><span class="p">],</span><span class="n">_</span> <span class="o">=</span> <span class="n">parse_value</span><span class="p">(</span><span class="n">comments</span><span class="p">[</span><span class="s">&#39;Detector Angle&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="write_file"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.write_file">[docs]</a><span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">original</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save probe as SNS reduced file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c">## Example header</span>
<span class="c">#F /SNSlocal/REF_L/2007_1_4B_SCI/2895/NeXus/REF_L_2895.nxs</span>
<span class="c">#E 1174593434.7</span>
<span class="c">#D 2007-03-22 15:57:14</span>
<span class="c">#C Run Number: 2895</span>
<span class="c">#C Title: MK NR4 dry 032007_No2Rep0</span>
<span class="c">#C Notes: MK NR 4 DU 53 dry from air</span>
<span class="c">#C Detector Angle: (0.0, &#39;degree&#39;)</span>
<span class="c">#C Proton Charge: 45.3205833435</span>

<span class="c">#S 1 Spectrum ID (&#39;bank1&#39;, (85, 151))</span>
<span class="c">#N 3</span>
<span class="c">#L time_of_flight(microsecond) data() Sigma()</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">original</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">original</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>     <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span> <span class="p">(</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#F &#39;</span><span class="o">+</span><span class="n">original</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#D &#39;</span><span class="o">+</span><span class="n">date</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#C Run Number: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">run</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#C Title: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#C Notes: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">notes</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;#C Detector Angle: (</span><span class="si">%g</span><span class="s">, &#39;degree&#39;)&quot;</span><span class="o">%</span><span class="n">probe</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#C Proton Charge: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">charge</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#N 5&#39;</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;#L Q(1/A) dQ(1/A) R() dR() L(A)&#39;</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">probe</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="s">&#39;dQ&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="s">&#39;dR&#39;</span><span class="p">,</span><span class="s">&#39;L&#39;</span><span class="p">],</span>
                     <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SNSData"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.SNSData">[docs]</a><span class="k">class</span> <span class="nc">SNSData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="SNSData.load"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.SNSData.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="c"># TODO: print &quot;Insert correct slit distances for Liquids and Magnetic&quot;</span></div></div>
<div class="viewcode-block" id="Liquids"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.Liquids">[docs]</a><span class="k">class</span> <span class="nc">Liquids</span><span class="p">(</span><span class="n">SNSData</span><span class="p">,</span> <span class="n">Pulsed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loader for reduced data from the SNS Liquids instrument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="s">&quot;Liquids&quot;</span>
    <span class="n">radiation</span> <span class="o">=</span> <span class="s">&quot;neutron&quot;</span>
    <span class="n">feather</span> <span class="o">=</span> <span class="n">LIQUIDS_FEATHER</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">2.</span><span class="p">,</span><span class="mf">15.</span>
    <span class="c">#wavelength = 0.5,5</span>
    <span class="c">#wavelength = 5.5,10</span>
    <span class="c">#wavelength = 10.5,15</span>
    <span class="n">dLoL</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">d_s1</span> <span class="o">=</span> <span class="mf">230.0</span> <span class="o">+</span> <span class="mf">1856.0</span>
    <span class="n">d_s2</span> <span class="o">=</span> <span class="mf">230.0</span>
    <span class="n">d_moderator</span> <span class="o">=</span> <span class="mf">14.850</span> <span class="c"># moderator to detector distance</span>
    <span class="n">TOF_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6000</span><span class="p">,</span><span class="mf">60000</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Magnetic"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.Magnetic">[docs]</a><span class="k">class</span> <span class="nc">Magnetic</span><span class="p">(</span><span class="n">SNSData</span><span class="p">,</span> <span class="n">Pulsed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loader for reduced data from the SNS Magnetic instrument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="s">&quot;Magnetic&quot;</span>
    <span class="n">radiation</span> <span class="o">=</span> <span class="s">&quot;neutron&quot;</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">,</span><span class="mf">14</span>
    <span class="n">dLoL</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">d_s1</span> <span class="o">=</span> <span class="mf">75</span><span class="o">*</span><span class="mf">2.54</span>
    <span class="n">d_s2</span> <span class="o">=</span> <span class="mf">14</span><span class="o">*</span><span class="mf">2.54</span>

<span class="c"># Instrument names assigned by reflpak</span></div>
<span class="n">INSTRUMENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;Liquids&#39;</span><span class="p">:</span> <span class="n">Liquids</span><span class="p">,</span>
    <span class="s">&#39;Magnetic&#39;</span><span class="p">:</span> <span class="n">Magnetic</span><span class="p">,</span>
    <span class="p">}</span>



<span class="c"># ===== utils ==============</span>

<div class="viewcode-block" id="intensity_from_spline"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.intensity_from_spline">[docs]</a><span class="k">def</span> <span class="nf">intensity_from_spline</span><span class="p">(</span><span class="n">Lrange</span><span class="p">,</span><span class="n">dLoL</span><span class="p">,</span><span class="n">feather</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">danse.reflectometry.reduction</span> <span class="kn">import</span> <span class="n">rebin</span>
    <span class="n">L0</span><span class="p">,</span><span class="n">L1</span> <span class="o">=</span> <span class="n">Lrange</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L1</span><span class="o">/</span><span class="n">L0</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">dLoL</span><span class="p">))</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">L0</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">dLoL</span><span class="p">)</span><span class="o">**</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">L</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="n">L</span><span class="p">[</span><span class="mf">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2</span><span class="p">,</span> <span class="n">rebin</span><span class="p">(</span><span class="n">feather</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">feather</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">L</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="boltzmann_feather"><a class="viewcode-back" href="../../api/snsdata.html#refl1d.snsdata.boltzmann_feather">[docs]</a><span class="k">def</span> <span class="nf">boltzmann_feather</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">counts</span><span class="o">=</span><span class="mf">100000</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return expected intensity as a function of wavelength given the TOF</span>
<span class="sd">    feather range and the total number of counts.</span>

<span class="sd">    TOF feather is approximately a boltzmann distribution with gaussian</span>
<span class="sd">    convolution.  The following looks pretty enough; don&#39;t know how well it</span>
<span class="sd">    corresponds to the actual SNS feather.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy.stats</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">4</span><span class="p">,</span><span class="mf">4</span><span class="p">,</span><span class="mf">10</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="o">**</span><span class="mf">2</span><span class="o">/</span><span class="mf">10</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">12</span><span class="p">,</span><span class="mf">85</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">boltzmann</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">16</span><span class="p">)</span>
    <span class="n">BGz</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>
    <span class="c">#if range is None: range = L[0],L[-1]</span>
    <span class="c">#if range[0] &gt; range[1]: range = range[::-1]</span>
    <span class="c">#range = range[0]*(1-1e-15),range[1]*(1+1e-15)</span>
    <span class="c">#z = numpy.linspace(range[0],range[1],len(BGz))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="mf">16.5</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">BGz</span><span class="p">))</span>  <span class="c"># Wavelength range for liquids</span>
    <span class="n">pL</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">BGz</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">0</span><span class="p">)</span>
    <span class="n">nL</span> <span class="o">=</span> <span class="n">pL</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">pL</span><span class="p">)</span><span class="o">*</span><span class="n">counts</span>
    <span class="k">return</span>  <span class="n">nL</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2006-2011, Paul Kienzle, Nikunj Patel, James Krycka.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>