

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refl1d.bspline &mdash; Refl1D v0.6.19 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku-site.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Refl1D v0.6.19 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>Refl1D v0.6.19 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.bspline</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for refl1d.bspline</h1><div class="highlight"><pre>
<span class="c"># This program is public domain</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">BSpline calculator.</span>

<span class="sd">Given a set of knots, compute the degree 3 B-spline and any derivatives</span>
<span class="sd">that are required.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<div class="viewcode-block" id="max"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.max">[docs]</a><span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="min"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.min">[docs]</a><span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">&gt;</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pbs"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.pbs">[docs]</a><span class="k">def</span> <span class="nf">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the parametric B-spline x(t),y(t) in [0,1].</span>

<span class="sd">    The knots are assumed to be equally spaced within 0,1.  x values are</span>
<span class="sd">    sorted.</span>

<span class="sd">    The spline goes through the control points at the ends.  If clamp is True,</span>
<span class="sd">    the derivative of the spline at both ends is zero.  If clamp is False,</span>
<span class="sd">    the derivative at the ends is equal to the slope connecting the final</span>
<span class="sd">    pair of control points.</span>

<span class="sd">    If parametric is False, then parametric points t&#39; are chosen such that</span>
<span class="sd">    x(t&#39;) = t.  The control points x must be linearly increasing for this</span>
<span class="sd">    to work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">knot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],(</span><span class="mf">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span>
                           <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
                           <span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span><span class="o">*</span><span class="mf">3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],(</span><span class="mf">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span>
                           <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
                           <span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                           <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span>
                           <span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
                           <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
        <span class="c">#cx = numpy.hstack(([x[0]]*3, x, x[-1]))</span>
        <span class="c">#cy = numpy.hstack(([y[0]]*3, y, y[-1]))</span>

    <span class="k">if</span> <span class="n">parametric</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>

    <span class="c"># Find parametric t values corresponding to given z values</span>
    <span class="c"># First try a few newton steps</span>
    <span class="n">xt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">6</span><span class="p">):</span>
        <span class="n">Pt</span><span class="p">,</span><span class="n">dPt</span> <span class="o">=</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">xt</span><span class="p">,</span><span class="n">nderiv</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">dPt</span><span class="o">!=</span><span class="mf">0</span>
        <span class="n">xt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xt</span> <span class="o">-</span> <span class="p">(</span><span class="n">Pt</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">dPt</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
    <span class="c"># Use bisection when newton failed</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">xt</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c">#print missing</span>
        <span class="n">t_lo</span><span class="p">,</span> <span class="n">t_hi</span> <span class="o">=</span> <span class="mf">0</span><span class="o">*</span><span class="n">missing</span><span class="p">,</span> <span class="mf">1</span><span class="o">*</span><span class="n">missing</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">30</span><span class="p">):</span> <span class="c"># bisection with about 1e-9 tolerance</span>
            <span class="n">trial</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_lo</span><span class="o">+</span><span class="n">t_hi</span><span class="p">)</span><span class="o">/</span><span class="mf">2</span>
            <span class="n">Ptrial</span> <span class="o">=</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">trial</span><span class="p">)</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="n">Ptrial</span><span class="o">&lt;</span><span class="n">missing</span>
            <span class="n">t_lo</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
            <span class="n">t_hi</span><span class="p">[</span><span class="o">~</span><span class="n">tidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="o">~</span><span class="n">tidx</span><span class="p">]</span>
        <span class="n">xt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_lo</span><span class="o">+</span><span class="n">t_hi</span><span class="p">)</span><span class="o">/</span><span class="mf">2</span>
    <span class="c">#print &quot;err&quot;,numpy.max(abs(_bspline3(knot,cx,t)-xt))</span>

    <span class="c"># Return y evaluated at the interpolation points</span>
    <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">xt</span><span class="p">),</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">xt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="bspline"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.bspline">[docs]</a><span class="k">def</span> <span class="nf">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the B-spline at positions xt in [0,1].</span>

<span class="sd">    The knots are assumed to be equally spaced within 0,1.</span>

<span class="sd">    The spline goes through the control points at the ends.  If clamp is True,</span>
<span class="sd">    the derivative of the spline at both ends is zero.  If clamp is False,</span>
<span class="sd">    the derivative at the ends is equal to the slope connecting the final</span>
<span class="sd">    pair of control points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(([</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span><span class="o">*</span><span class="mf">3</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                           <span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span>
                           <span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span>
                           <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">3</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">xt</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">_bspline3</span><span class="p">(</span><span class="n">knot</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">nderiv</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the B-spline specified by the given knot sequence and</span>
<span class="sd">    control values at the parametric points t.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knot</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">knot</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

    <span class="c"># Deal with values outside the range</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">knot</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">knot</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span>
    <span class="n">tv</span>  <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
    <span class="n">f</span>   <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">knot</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">f</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;=</span><span class="n">knot</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>

    <span class="c"># Find B-Spline parameters for the individual segments</span>
    <span class="n">end</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">knot</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">knot</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span>
    <span class="n">tm2</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span><span class="o">-</span><span class="mf">2</span><span class="p">,</span><span class="mf">0</span><span class="p">)]</span>
    <span class="n">tm1</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="p">)]</span>
    <span class="n">tm0</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">segment</span><span class="o">-</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">)]</span>
    <span class="n">tp1</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">tp2</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">2</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">tp3</span> <span class="o">=</span> <span class="n">knot</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">3</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>

    <span class="n">P4</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">3</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">2</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">segment</span><span class="o">+</span><span class="mf">0</span><span class="p">,</span><span class="n">end</span><span class="p">)]</span>

    <span class="c"># Compute second and third derivatives.</span>
    <span class="k">if</span> <span class="n">nderiv</span> <span class="o">&gt;</span> <span class="mf">1</span><span class="p">:</span>
        <span class="c"># Normally we require a recursion for Q, R and S to compute</span>
        <span class="c"># df, d2f and d3f respectively, however Q can be computed directly</span>
        <span class="c"># from intermediate values of P, S has a recursion of depth 0,</span>
        <span class="c"># which leaves only the R recursion of depth 1 in the calculation</span>
        <span class="c"># below.</span>
        <span class="n">Q4</span> <span class="o">=</span> <span class="p">(</span><span class="n">P4</span> <span class="o">-</span> <span class="n">P3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp3</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span>
        <span class="n">Q3</span> <span class="o">=</span> <span class="p">(</span><span class="n">P3</span> <span class="o">-</span> <span class="n">P2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span><span class="o">-</span><span class="n">tm1</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="p">(</span><span class="n">P2</span> <span class="o">-</span> <span class="n">P1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tm2</span><span class="p">)</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q4</span> <span class="o">-</span> <span class="n">Q3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span>
        <span class="n">R3</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q3</span> <span class="o">-</span> <span class="n">Q2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tm1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nderiv</span> <span class="o">&gt;</span> <span class="mf">2</span><span class="p">:</span>
            <span class="n">S4</span> <span class="o">=</span> <span class="p">(</span><span class="n">R4</span> <span class="o">-</span> <span class="n">R3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span>
            <span class="n">d3f</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">d3f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">S4</span>
        <span class="n">R4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span><span class="o">*</span><span class="n">R4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">R3</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
        <span class="n">d2f</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">d2f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">R4</span>

    <span class="c"># Compute function value and first derivative</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp3</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp3</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm1</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp2</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm2</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm2</span><span class="p">)</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp2</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp2</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm1</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm1</span><span class="p">)</span>
    <span class="k">if</span>  <span class="n">nderiv</span> <span class="o">&gt;=</span> <span class="mf">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">P4</span><span class="o">-</span><span class="n">P3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tv</span><span class="o">-</span><span class="n">tm0</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp1</span><span class="o">-</span><span class="n">tv</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp1</span> <span class="o">-</span> <span class="n">tm0</span><span class="p">)</span>
    <span class="n">f</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>  <span class="o">=</span> <span class="n">P4</span>

    <span class="k">if</span>   <span class="n">nderiv</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">f</span>
    <span class="k">elif</span> <span class="n">nderiv</span> <span class="o">==</span> <span class="mf">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">df</span>
    <span class="k">elif</span> <span class="n">nderiv</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">d2f</span>
    <span class="k">else</span><span class="p">:</span>             <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">d2f</span><span class="p">,</span><span class="n">d3f</span>


<div class="viewcode-block" id="bspline_control"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.bspline_control">[docs]</a><span class="k">def</span> <span class="nf">bspline_control</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_find_control</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pbs_control"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.pbs_control">[docs]</a><span class="k">def</span> <span class="nf">pbs_control</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_find_control</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">),</span> <span class="n">_find_control</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="n">clamp</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">_find_control</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;B-spline interpolation doesn&#39;t work yet&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">solve_banded</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">udiag</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="o">/</span><span class="mf">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mf">3</span><span class="p">),</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ldiag</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="p">[</span><span class="mf">1</span><span class="o">/</span><span class="mf">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mf">3</span><span class="p">),</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">])</span>
    <span class="n">mdiag</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">7</span><span class="o">/</span><span class="mf">12</span><span class="p">,</span> <span class="p">[</span><span class="mf">2</span><span class="o">/</span><span class="mf">3</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mf">4</span><span class="p">),</span> <span class="mf">7</span><span class="o">/</span><span class="mf">12</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">ldiag</span><span class="p">,</span> <span class="n">mdiag</span><span class="p">,</span> <span class="n">udiag</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">clamp</span><span class="p">:</span>
        <span class="c"># First derivative is zero at ends</span>
        <span class="n">bl</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># First derivative at ends follows line between final control points</span>
        <span class="n">bl</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">*</span><span class="n">N</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">bl</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="n">N</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span> <span class="n">br</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">solve_banded</span><span class="p">((</span><span class="mf">1</span><span class="p">,</span><span class="mf">1</span><span class="p">),</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="c">#x[1:-1]</span>

<div class="viewcode-block" id="speed_check"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.speed_check">[docs]</a><span class="k">def</span> <span class="nf">speed_check</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="mf">7</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">3</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="mf">400</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mf">1000</span><span class="p">):</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;bspline (ms)&quot;</span><span class="p">,(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="mf">1000</span>
</div>
<span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="n">got</span><span class="p">,</span><span class="n">tol</span><span class="p">):</span>
    <span class="n">relative</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expected</span><span class="o">!=</span><span class="mf">0</span><span class="p">)</span> \
        <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all</span><span class="p">(</span><span class="n">expected</span><span class="o">!=</span><span class="mf">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">expected</span><span class="o">-</span><span class="n">got</span><span class="p">)</span><span class="o">/</span><span class="n">expected</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expected</span><span class="o">-</span><span class="n">got</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">norm</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;expected&quot;</span><span class="p">,</span><span class="n">expected</span>
        <span class="k">print</span> <span class="s">&quot;got&quot;</span><span class="p">,</span><span class="n">got</span>
        <span class="k">print</span> <span class="s">&quot;tol&quot;</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="s">&quot;norm&quot;</span><span class="p">,</span><span class="n">norm</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_derivs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="c"># difference formula</span>
    <span class="c">#return (y[1]-y[0])/(x[1]-x[0]), (y[-1]-y[-2])/(x[-1]-x[-2])</span>
    <span class="c"># 5-point difference formula</span>
    <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">-</span><span class="mf">8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="mf">8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">4</span><span class="p">])</span> <span class="o">/</span> <span class="mf">12</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">5</span><span class="p">]</span><span class="o">-</span><span class="mf">8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">4</span><span class="p">]</span><span class="o">+</span><span class="mf">8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">12</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">left</span><span class="p">,</span><span class="n">right</span>

<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="mf">100</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span>
                      <span class="mf">1</span><span class="o">-</span><span class="mf">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">1</span><span class="o">-</span><span class="mf">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">1</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">1</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="mf">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">xeq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xeq</span><span class="o">+</span><span class="mf">0</span>
    <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="mf">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="mf">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span>
                       <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="mf">4</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="mf">3</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="p">])</span>

    <span class="c"># ==== Check that bspline matches pbs with equally spaced x</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">xtp</span><span class="p">,</span><span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">xtp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xtp</span><span class="p">,</span><span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">xtp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">xtp</span><span class="p">,</span><span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">xtp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xtp</span><span class="p">,</span><span class="n">ytp</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">xtp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">,</span><span class="mf">1e-8</span><span class="p">)</span>


    <span class="c"># ==== Check bspline f at end points</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-12</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">xt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">yt</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">1e-8</span><span class="p">)</span>

    <span class="c"># ==== Check f&#39; at end points</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="n">yt</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">1</span><span class="p">),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">1</span><span class="p">),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">left</span><span class="p">,</span><span class="n">right</span> <span class="o">=</span> <span class="n">_derivs</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span> <span class="n">left</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>
    <span class="n">_check</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">2</span><span class="p">]),</span> <span class="n">right</span><span class="p">,</span> <span class="mf">5e-4</span><span class="p">)</span>


    <span class="c"># ==== Check interpolator</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">bspline_control</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;y&quot;</span><span class="p">,</span><span class="n">y</span>
    <span class="k">print</span> <span class="s">&quot;p(yc)&quot;</span><span class="p">,</span><span class="n">bspline</span><span class="p">(</span><span class="n">yc</span><span class="p">,</span><span class="n">xeq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="demo"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.demo">[docs]</a><span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">hold</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">show</span>
    <span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#y = [9,6,1,3,8,4,2]</span>
    <span class="c">#y = [9,11,13,3,-2,0,2]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="p">]</span>
    <span class="c">#y = [9,9,1,3,8,2,2]</span>
    <span class="n">xeq</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xeq</span><span class="o">+</span><span class="mf">0</span>
    <span class="c">#x[1],x[-2] = x[0],x[-1]</span>
    <span class="c">#x[1],x[-2] = x[2],x[-3]</span>
    <span class="c">#x[1],x[2] = x[2],x[1]</span>
    <span class="c">#x[1],x[-2] = x[2]-0.001,x[-2]+0.001</span>
    <span class="c">#x[1],x[-2] = x[1]-x[1]/2,x[-1]-x[1]/2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">400</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;:oy&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span><span class="s">&#39;-.y&#39;</span><span class="p">)</span> <span class="c"># bspline</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">bspline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span><span class="s">&#39;-y&#39;</span><span class="p">)</span> <span class="c"># bspline</span>

    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="s">&#39;-.b&#39;</span><span class="p">)</span> <span class="c"># pbs</span>
    <span class="n">xt</span><span class="p">,</span><span class="n">yt</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="s">&#39;-b&#39;</span><span class="p">)</span> <span class="c"># pbs</span>
    <span class="c">#xt,yt = pbs(x,y,t,clamp=True, parametric=True)</span>
    <span class="c">#plot(xt,yt,&#39;-g&#39;) # pbs</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;:ob&#39;</span><span class="p">)</span>
    <span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="demo_interp"><a class="viewcode-back" href="../../api/bspline.html#refl1d.bspline.demo_interp">[docs]</a><span class="k">def</span> <span class="nf">demo_interp</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">hold</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">show</span>
    <span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">xeq</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="mf">7</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xeq</span><span class="o">+</span><span class="mf">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="mf">400</span><span class="p">)</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">bspline_control</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">9</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="s">&#39;:oy&#39;</span><span class="p">,</span><span class="n">xeq</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;xg&#39;</span><span class="p">)</span>
    <span class="n">knot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mf">1</span><span class="p">))</span>
    <span class="c"># fy = _bspline3(knot,yc,t)</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">bspline</span><span class="p">(</span><span class="n">yc</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="s">&#39;-.y&#39;</span><span class="p">)</span>
    <span class="n">show</span><span class="p">()</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c">#test()</span>
    <span class="n">demo</span><span class="p">()</span>
    <span class="c">#demo_interp()</span>
    <span class="c">#speed_check()</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2006-2011, Paul Kienzle, Nikunj Patel, James Krycka.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>