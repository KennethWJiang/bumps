

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refl1d.mono &mdash; Refl1D v0.6.19 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku-site.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Refl1D v0.6.19 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>Refl1D v0.6.19 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.mono</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for refl1d.mono</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Monotonic spline modeling for free interfaces</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">hstack</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">searchsorted</span><span class="p">,</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">,</span>
                   <span class="n">inf</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">isnan</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mystic.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span> <span class="k">as</span> <span class="n">Par</span><span class="p">,</span> <span class="n">Function</span> <span class="k">as</span> <span class="n">ParFunction</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">numpyerrors</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">Layer</span>

<span class="c">#TODO: add left_sld,right_sld to all layers so that fresnel works</span>
<span class="c">#TODO: access left_sld,right_sld so freeform doesn&#39;t need left,right</span>
<span class="c">#TODO: restructure to use vector parameters</span>
<span class="c">#TODO: allow the number of layers to be adjusted by the fit</span>
<div class="viewcode-block" id="FreeLayer"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeLayer">[docs]</a><span class="k">class</span> <span class="nc">FreeLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with splines.</span>

<span class="sd">    sld (rho) and imaginary sld (irho) can be modeled with a separate</span>
<span class="sd">    number of control points. The control points can be equally spaced</span>
<span class="sd">    in the layers unless rhoz or irhoz are specified. If the z values</span>
<span class="sd">    are given, they must be in the range [0,1].  One control point is</span>
<span class="sd">    anchored at either end, so there are two fewer z values than controls</span>
<span class="sd">    if z values are given.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">below</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">above</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">z</span><span class="o">=</span><span class="p">[],</span> <span class="n">rho</span><span class="o">=</span><span class="p">[],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[],</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Freeform&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span> <span class="o">=</span> <span class="n">below</span><span class="p">,</span><span class="n">above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">,</span>
                                     <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; interface&quot;</span><span class="p">,</span>
                                     <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">fittable</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">parvec</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">limits</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vector</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> \
            <span class="o">=</span> <span class="p">[</span><span class="n">parvec</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">part</span><span class="p">,</span><span class="n">limits</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">part</span><span class="p">,</span><span class="n">limits</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;irho&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">),</span>
                                        <span class="p">((</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">),(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
                                        <span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;must have one z for each rho value&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;must have one z for each irho value&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FreeLayer.parameters"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeLayer.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="p">,</span>
                    <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
                    <span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span>
                    <span class="n">irho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">,</span>
                    <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="n">below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="p">)</span></div>
<div class="viewcode-block" id="FreeLayer.profile"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeLayer.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pz</span><span class="p">,</span> <span class="n">below</span><span class="p">,</span> <span class="n">above</span><span class="p">):</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
        <span class="n">rbelow</span><span class="p">,</span><span class="n">ibelow</span> <span class="o">=</span> <span class="n">below</span>
        <span class="n">rabove</span><span class="p">,</span><span class="n">iabove</span> <span class="o">=</span> <span class="n">above</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">sort</span><span class="p">([</span><span class="mf">0</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="o">*</span><span class="n">thickness</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">rbelow</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">],</span> <span class="n">rabove</span><span class="p">))</span>
        <span class="n">Prho</span> <span class="o">=</span> <span class="n">monospline</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">Pz</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Prho</span><span class="p">)):</span>
            <span class="k">print</span> <span class="s">&quot;in mono&quot;</span>
            <span class="k">print</span> <span class="s">&quot;z&quot;</span><span class="p">,</span><span class="n">z</span>
            <span class="k">print</span> <span class="s">&quot;p&quot;</span><span class="p">,[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">irho</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">ibelow</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">],</span> <span class="n">iabove</span><span class="p">))</span>
            <span class="n">Pirho</span> <span class="o">=</span> <span class="n">monospline</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">irho</span><span class="p">,</span> <span class="n">Pz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Pirho</span> <span class="o">=</span> <span class="mf">0</span><span class="o">*</span><span class="n">Prho</span>
        <span class="k">return</span> <span class="n">Prho</span><span class="p">,</span><span class="n">Pirho</span>
</div>
<div class="viewcode-block" id="FreeLayer.render"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeLayer.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">below</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">above</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">Prho</span><span class="p">,</span><span class="n">Pirho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">Pz</span><span class="p">,</span> <span class="n">below</span><span class="p">,</span> <span class="n">above</span><span class="p">)</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="inflections"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.inflections">[docs]</a><span class="k">def</span> <span class="nf">inflections</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">count_inflections</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="FreeInterface"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeInterface">[docs]</a><span class="k">class</span> <span class="nc">FreeInterface</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with monotonic splines.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">below</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">above</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Interface&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span> <span class="o">=</span> <span class="n">below</span><span class="p">,</span><span class="n">above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; interface&quot;</span><span class="p">)</span>


        <span class="c"># Choose reasonable defaults if not given</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="mf">5</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Need one dz for every dp&quot;</span><span class="p">)</span>

        <span class="c">#if len(z) != len(vf)+2:</span>
        <span class="c">#    raise ValueError(&quot;Only need vf for interior z, so len(z)=len(vf)+2&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dz[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dz</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dp[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dp</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inflections</span> <span class="o">=</span> <span class="n">ParFunction</span><span class="p">(</span><span class="n">inflections</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">,</span>
                                       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; inflections&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FreeInterface.parameters"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeInterface.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span>
                    <span class="n">dp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">,</span>
                    <span class="n">below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="p">,</span>
                    <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
                    <span class="n">inflections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inflections</span><span class="p">)</span></div>
<div class="viewcode-block" id="FreeInterface.profile"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeInterface.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pz</span><span class="p">):</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
        <span class="n">z</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">(</span><span class="n">asarray</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">],</span><span class="s">&#39;d&#39;</span><span class="p">)))</span> <span class="p">)</span>
               <span class="k">for</span> <span class="n">vector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="n">p</span> <span class="o">*=</span> <span class="mf">1</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">*=</span> <span class="n">thickness</span><span class="o">/</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">monospline</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">Pz</span><span class="p">),</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span></div>
<div class="viewcode-block" id="FreeInterface.render"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.FreeInterface.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">value</span>
        <span class="n">below_rho</span><span class="p">,</span><span class="n">below_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">above_rho</span><span class="p">,</span><span class="n">above_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="c"># Pz is the center, Pw is the width</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">Pz</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_ends</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">Prho</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">below_rho</span>  <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">above_rho</span>
        <span class="n">Pirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">below_irho</span> <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">above_irho</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</div></div>
<span class="nd">@numpyerrors</span><span class="o">.</span><span class="n">ignored</span>
<div class="viewcode-block" id="count_inflections"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.count_inflections">[docs]</a><span class="k">def</span> <span class="nf">count_inflections</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count the number of inflection points in the spline curve</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span><span class="o">-</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span><span class="o">-</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">nonzero</span><span class="p">(</span><span class="n">delta</span><span class="p">)]</span> <span class="c"># ignore points on the line</span>
    <span class="n">sign_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span><span class="o">*</span><span class="n">delta</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sign_change</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="plot_inflection"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.plot_inflection">[docs]</a><span class="k">def</span> <span class="nf">plot_inflection</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span><span class="o">-</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span><span class="o">-</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mf">2</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">:]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="mf">400</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pylab</span>
    <span class="n">ax1</span><span class="o">=</span><span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mf">211</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">monospline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="s">&#39;-b&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;ob&#39;</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mf">212</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">delta_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">delta_x</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">delta_x</span><span class="p">[</span><span class="n">delta</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">],</span><span class="n">delta</span><span class="p">[</span><span class="n">delta</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">],</span><span class="s">&#39;og&#39;</span><span class="p">)</span>
    <span class="n">pylab</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span><span class="mf">0</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span><span class="mf">0</span><span class="p">)])</span>

</div>
<span class="nd">@numpyerrors</span><span class="o">.</span><span class="n">ignored</span>
<div class="viewcode-block" id="monospline"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.monospline">[docs]</a><span class="k">def</span> <span class="nf">monospline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xt</span><span class="p">):</span>
    <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    Monotonic cubic hermite interpolation.</span>

<span class="s">    Returns $p(x_t)$ where $p(x_i)= y_i$ and $p(x) \leq p(xi)$</span>
<span class="s">    if $y_i \leq y_{i+1}$ for all $y_i$.  Also works for decreasing</span>
<span class="s">    values $y$, resulting in decreasing $p(x)$.  If $y$ is not monotonic,</span>
<span class="s">    then $p(x)$ may peak higher than any $y$, so this function is not</span>
<span class="s">    suitable for a strict constraint on the interpolated function when</span>
<span class="s">    $y$ values are unconstrained.</span>

<span class="s">    http://en.wikipedia.org/wiki/Monotone_cubic_interpolation</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">dy</span><span class="o">/</span><span class="n">dx</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span><span class="o">+</span><span class="n">delta</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="o">/</span><span class="n">delta</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span><span class="o">/</span><span class="n">delta</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">**</span><span class="mf">2</span><span class="o">+</span><span class="n">beta</span><span class="o">**</span><span class="mf">2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">-</span><span class="mf">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span> <span class="ow">or</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span> <span class="ow">or</span> <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">elif</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">9</span><span class="p">:</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c">#if numpy.isnan(m[i]) or numpy.isnan(m[i+1]):</span>
            <span class="c">#    print i,&quot;isnan&quot;,tau,d[i], alpha[i],beta[i],delta[i]</span>
        <span class="c">#elif numpy.isnan(m[i]):</span>
        <span class="c">#    print i,&quot;isnan&quot;,delta[i],dy[i]</span>
    <span class="c">#m[ dy[1:]*dy[:-1]&lt;0 ] = 0</span>
    <span class="n">m</span><span class="p">[</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0</span>

    <span class="k">return</span> <span class="n">hermite</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">xt</span><span class="p">)</span>

</div>
<span class="nd">@numpyerrors</span><span class="o">.</span><span class="n">ignored</span>
<div class="viewcode-block" id="hermite"><a class="viewcode-back" href="../../api/mono.html#refl1d.mono.hermite">[docs]</a><span class="k">def</span> <span class="nf">hermite</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">xt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the cubic hermite polynomial p(xt).</span>

<span class="sd">    The polynomial goes through all points (x_i,y_i) with slope</span>
<span class="sd">    m_i at the point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">xt</span> <span class="o">=</span> <span class="p">[</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;d&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">xt</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">xt</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="o">&lt;=</span><span class="mf">1e-10</span><span class="p">]</span><span class="o">=</span><span class="mf">1e-10</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">/</span><span class="n">h</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">xt</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">c3</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c0</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">/</span><span class="n">h</span><span class="o">**</span><span class="mf">2</span><span class="p">,</span>
                   <span class="p">(</span><span class="mf">3</span><span class="o">*</span><span class="n">s</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mf">1</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="p">,</span>
                   <span class="n">m</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                   <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">c3</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">c0</span>



<span class="c"># CRUFT: still working on best rep&#39;n for control point locations</span></div>
<span class="k">class</span> <span class="nc">_FreeInterfaceW</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with monotonic splines.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">below</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">above</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Interface&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span> <span class="o">=</span> <span class="n">below</span><span class="p">,</span><span class="n">above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; interface&quot;</span><span class="p">)</span>

        <span class="c"># Choose reasonable defaults if not given</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="mf">5</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Need one dz for every dp&quot;</span><span class="p">)</span>
        <span class="c">#if len(z) != len(vf)+2:</span>
        <span class="c">#    raise ValueError(&quot;Only need vf for interior z, so len(z)=len(vf)+2&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dz[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dz</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dp[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dp</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">_get_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Par</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mf">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;thickness cannot be set for FreeformInterface&quot;</span><span class="p">)</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_thickness</span><span class="p">,</span> <span class="n">_set_thickness</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span>
                    <span class="n">dp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">,</span>
                    <span class="n">below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">value</span>
        <span class="n">below_rho</span><span class="p">,</span><span class="n">below_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">above_rho</span><span class="p">,</span><span class="n">above_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="n">p</span> <span class="o">/=</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">monospline</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">Pz</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_ends</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">Prho</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">below_rho</span>  <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">above_rho</span>
        <span class="n">Pirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">below_irho</span> <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">above_irho</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2006-2011, Paul Kienzle, Nikunj Patel, James Krycka.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>