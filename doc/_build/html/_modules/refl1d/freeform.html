

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refl1d.freeform &mdash; Refl1D v0.6.19 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku-site.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Refl1D v0.6.19 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>Refl1D v0.6.19 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.freeform</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for refl1d.freeform</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Freeform modeling with B-Splines</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span><span class="p">,</span> <span class="n">argmin</span><span class="p">,</span> <span class="n">argmax</span>
<span class="kn">from</span> <span class="nn">mystic</span> <span class="kn">import</span> <span class="n">Parameter</span> <span class="k">as</span> <span class="n">Par</span><span class="p">,</span> <span class="n">IntegerParameter</span> <span class="k">as</span> <span class="n">IntPar</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">Layer</span>
<span class="kn">from</span> <span class="nn">.bspline</span> <span class="kn">import</span> <span class="n">pbs</span><span class="p">,</span> <span class="n">bspline</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>

<span class="c">#TODO: add left_sld,right_sld to all layers so that fresnel works</span>
<span class="c">#TODO: access left_sld,right_sld so freeform doesn&#39;t need left,right</span>
<span class="c">#TODO: restructure to use vector parameters</span>
<span class="c">#TODO: allow the number of layers to be adjusted by the fit</span>
<div class="viewcode-block" id="FreeLayer"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeLayer">[docs]</a><span class="k">class</span> <span class="nc">FreeLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with B-splines.</span>

<span class="sd">    sld (rho) and imaginary sld (irho) can be modeled with a separate</span>
<span class="sd">    number of control points. The control points can be equally spaced</span>
<span class="sd">    in the layers unless rhoz or irhoz are specified. If the z values</span>
<span class="sd">    are given, they must be in the range [0,1].  One control point is</span>
<span class="sd">    anchored at either end, so there are two fewer z values than controls</span>
<span class="sd">    if z values are given.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">rho</span><span class="o">=</span><span class="p">[],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[],</span> <span class="n">rhoz</span><span class="o">=</span><span class="p">[],</span> <span class="n">irhoz</span><span class="o">=</span><span class="p">[],</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Freeform&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">,</span><span class="n">right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                   <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rhoz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">irhoz</span> \
            <span class="o">=</span> <span class="p">[[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; [</span><span class="si">%d</span><span class="s">] </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">part</span><span class="p">),</span><span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
               <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">part</span><span class="p">,</span><span class="n">limits</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">,</span> <span class="n">rhoz</span><span class="p">,</span> <span class="n">irhoz</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;irho&#39;</span><span class="p">,</span> <span class="s">&#39;rhoz&#39;</span><span class="p">,</span> <span class="s">&#39;irhoz&#39;</span><span class="p">),</span>
                                        <span class="p">((</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">),(</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span><span class="n">inf</span><span class="p">),(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">),(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
                                        <span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhoz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhoz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;must have one z value for each rho&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irhoz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irhoz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;must have one z value for each irho&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="FreeLayer.parameters"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeLayer.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span>
                    <span class="n">rhoz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rhoz</span><span class="p">,</span>
                    <span class="n">irho</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">,</span>
                    <span class="n">irhoz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irhoz</span><span class="p">,</span>
                    <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="p">)</span></div>
<div class="viewcode-block" id="FreeLayer.render"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeLayer.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
        <span class="n">left_rho</span><span class="p">,</span><span class="n">left_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">right_rho</span><span class="p">,</span><span class="n">right_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Pz</span><span class="o">/</span><span class="n">thickness</span>
        <span class="n">Prho</span> <span class="o">=</span> <span class="n">_profile</span><span class="p">(</span><span class="n">left_rho</span><span class="p">,</span> <span class="n">right_rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhoz</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">Pirho</span> <span class="o">=</span> <span class="n">_profile</span><span class="p">(</span><span class="n">left_irho</span><span class="p">,</span> <span class="n">right_irho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">irhoz</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="FreeformInterface01"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeformInterface01">[docs]</a><span class="k">class</span> <span class="nc">FreeformInterface01</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with B-splines.</span>

<span class="sd">    sld (rho) and imaginary sld (irho) can be modeled with a separate</span>
<span class="sd">    number of control points. The control points can be equally spaced</span>
<span class="sd">    in the layers unless rhoz or irhoz are specified. If the z values</span>
<span class="sd">    are given, they must be in the range [0,1].  One control point is</span>
<span class="sd">    anchored at either end, so there are two fewer z values than controls</span>
<span class="sd">    if z values are given.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">below</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">above</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">z</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Interface&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span> <span class="o">=</span> <span class="n">below</span><span class="p">,</span><span class="n">above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">thickness</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; interface&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Need one vf for every z&quot;</span><span class="p">)</span>
        <span class="c">#if len(z) != len(vf)+2:</span>
        <span class="c">#    raise ValueError(&quot;Only need vf for interior z, so len(z)=len(vf)+2&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; z[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vf</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; vf[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vf</span><span class="p">)]</span>
<div class="viewcode-block" id="FreeformInterface01.parameters"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeformInterface01.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                    <span class="n">vf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vf</span><span class="p">,</span>
                    <span class="n">below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="p">)</span></div>
<div class="viewcode-block" id="FreeformInterface01.render"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeformInterface01.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="o">.</span><span class="n">value</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">value</span>
        <span class="n">left_rho</span><span class="p">,</span><span class="n">left_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">right_rho</span><span class="p">,</span><span class="n">right_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span> <span class="n">sorted</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">]),</span> <span class="mf">1</span><span class="p">))</span>
        <span class="n">vf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span> <span class="n">sorted</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vf</span><span class="p">]),</span> <span class="mf">1</span><span class="p">))</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Pz</span><span class="o">/</span><span class="n">thickness</span>
        <span class="n">offset</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_ends</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">Prho</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">left_rho</span>  <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">right_rho</span>
        <span class="n">Pirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">left_irho</span> <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">right_irho</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="FreeInterface"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeInterface">[docs]</a><span class="k">class</span> <span class="nc">FreeInterface</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A freeform section of the sample modeled with monotonic splines.</span>

<span class="sd">    Layers have a slope of zero at the ends, so the automatically blend</span>
<span class="sd">    with slabs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">below</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">above</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">dz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Interface&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span> <span class="o">=</span> <span class="n">below</span><span class="p">,</span><span class="n">above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; interface&quot;</span><span class="p">)</span>

        <span class="c"># Choose reasonable defaults if not given</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="mf">5</span>
        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Need one dz for every dp&quot;</span><span class="p">)</span>
        <span class="c">#if len(z) != len(vf)+2:</span>
        <span class="c">#    raise ValueError(&quot;Only need vf for interior z, so len(z)=len(vf)+2&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dz[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dz</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="p">[</span><span class="n">Par</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; dp[</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dp</span><span class="p">)]</span>
    <span class="k">def</span> <span class="nf">_get_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Par</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot; thickness&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mf">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;thickness cannot be set for FreeInterface&quot;</span><span class="p">)</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_thickness</span><span class="p">,</span> <span class="n">_set_thickness</span><span class="p">)</span>

<div class="viewcode-block" id="FreeInterface.parameters"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeInterface.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span>
                    <span class="n">dp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">,</span>
                    <span class="n">below</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">above</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                    <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span></div>
<div class="viewcode-block" id="FreeInterface.render"><a class="viewcode-back" href="../../api/freeform.html#refl1d.freeform.FreeInterface.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">slabs</span><span class="p">):</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">value</span>
        <span class="n">left_rho</span><span class="p">,</span><span class="n">left_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">below</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">right_rho</span><span class="p">,</span><span class="n">right_irho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">above</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">]))</span> <span class="p">)</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="n">p</span> <span class="o">/=</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">slabs</span><span class="o">.</span><span class="n">microslabs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span>
        <span class="n">_</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">pbs</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">Pz</span><span class="p">,</span> <span class="n">parametric</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
        <span class="n">Pw</span><span class="p">,</span><span class="n">profile</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_ends</span><span class="p">(</span><span class="n">Pw</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">Prho</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">left_rho</span>  <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">right_rho</span>
        <span class="n">Pirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">profile</span><span class="p">)</span><span class="o">*</span><span class="n">left_irho</span> <span class="o">+</span> <span class="n">profile</span><span class="o">*</span><span class="n">right_irho</span>
        <span class="n">slabs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="p">[</span><span class="n">Prho</span><span class="p">],</span> <span class="n">irho</span><span class="o">=</span><span class="p">[</span><span class="n">Pirho</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">Pw</span><span class="p">)</span>
</div></div>
<span class="k">def</span> <span class="nf">_profile</span><span class="p">(</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">left</span><span class="p">,[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">control</span><span class="p">],</span><span class="n">right</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0</span><span class="p">:</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mf">0</span><span class="p">,[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">z</span><span class="p">],</span><span class="mf">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pbs</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bspline</span><span class="p">(</span><span class="n">cy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2006-2011, Paul Kienzle, Nikunj Patel, James Krycka.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>