

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>refl1d.probe &mdash; Refl1D v0.6.19 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku-site.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/MathJax/MathJax.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Refl1D v0.6.19 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span>Refl1D v0.6.19 documentation</span></a></h1>
        <h2 class="heading"><span>refl1d.probe</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for refl1d.probe</h1><div class="highlight"><pre>
<span class="c"># This program is in the public domain</span>
<span class="c"># Author: Paul Kienzle</span>
<span class="s">r&quot;&quot;&quot;</span>
<span class="s">Experimental probe.</span>

<span class="s">The experimental probe describes the incoming beam for the experiment.</span>
<span class="s">Scattering properties of the sample are dependent on the type and</span>
<span class="s">energy of the radiation.</span>

<span class="s">See `data-guide`_ for details.</span>

<span class="s">&quot;&quot;&quot;</span>

<span class="c"># TOF stitching introduces a lot of complexity.</span>
<span class="c"># Theta offset:</span>
<span class="c">#   Q1 = 4 pi sin(T1 + offset)/L1</span>
<span class="c">#   Q2 = 4 pi sin(T2 + offset)/L2</span>
<span class="c">#   at offset=0,</span>
<span class="c">#      Q1=Q2</span>
<span class="c">#   at offset!=0,</span>
<span class="c">#      Q1&#39; ~ Q1 + 4pi offset/L1</span>
<span class="c">#      Q2&#39; ~ Q2 + 4pi offset/L2</span>
<span class="c">#      =&gt; Q1&#39; != Q2&#39;</span>
<span class="c"># Thick layers:</span>
<span class="c">#   Since a given Q,dQ has multiple T,dT,L,dL, oversampling is going</span>
<span class="c">#   to be very complicated.</span>
<span class="c"># Energy dependent SLD:</span>
<span class="c">#   Just because two points are at the same Q does not mean they have</span>
<span class="c">#   the same theory function when scattering length density is</span>
<span class="c">#   energy dependent</span>
<span class="c">#</span>
<span class="c"># Not stitching has its own issues.</span>
<span class="c"># Calculation speed:</span>
<span class="c">#   overlapping points are recalculated</span>
<span class="c">#   profiles are recalculated</span>
<span class="c">#</span>
<span class="c"># Unstitched seems like the better bet.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">inf</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">periodictable</span> <span class="kn">import</span> <span class="n">nsf</span><span class="p">,</span> <span class="n">xsf</span>
<span class="kn">from</span> <span class="nn">.reflectivity</span> <span class="kn">import</span> <span class="n">convolve</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fresnel</span>
<span class="kn">from</span> <span class="nn">material</span> <span class="kn">import</span> <span class="n">Vacuum</span>
<span class="kn">from</span> <span class="nn">mystic.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Constant</span>
<span class="kn">from</span> <span class="nn">.resolution</span> <span class="kn">import</span> <span class="n">QL2T</span><span class="p">,</span> <span class="n">TL2Q</span><span class="p">,</span> <span class="n">dTdL2dQ</span>
<span class="kn">from</span> <span class="nn">.stitch</span> <span class="kn">import</span> <span class="n">stitch</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">coordinated_colors</span><span class="p">,</span> <span class="n">auto_shift</span>

<span class="n">PROBE_KW</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="s">&#39;dT&#39;</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="s">&#39;dL&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">,</span>
            <span class="s">&#39;intensity&#39;</span><span class="p">,</span> <span class="s">&#39;background&#39;</span><span class="p">,</span> <span class="s">&#39;back_absorption&#39;</span><span class="p">,</span>
            <span class="s">&#39;theta_offset&#39;</span><span class="p">,</span> <span class="s">&#39;back_reflectivity&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="make_probe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.make_probe">[docs]</a><span class="k">def</span> <span class="nf">make_probe</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a reflectometry measurement object of the given resolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">radiation</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;radiation&#39;</span><span class="p">)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">PROBE_KW</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radiation</span> <span class="o">==</span> <span class="s">&#39;neutron&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NeutronProbe</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">XrayProbe</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Probe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe">[docs]</a><span class="k">class</span> <span class="nc">Probe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    Defines the incident beam used to study the material.</span>

<span class="s">    For calculation purposes, probe needs to return the values $Q_\text{calc}$</span>
<span class="s">    at which the model is evaluated.  This is normally going to be the measured</span>
<span class="s">    points only, but for some systems, such as those with very thick layers,</span>
<span class="s">    oversampling is needed to avoid aliasing effects.</span>

<span class="s">    Measurement properties:</span>

<span class="s">        *intensity* is the beam intensity</span>
<span class="s">        *background* is the background</span>
<span class="s">        *back_absorption* is the amount of absorption through the substrate</span>
<span class="s">        *theta_offset* is the offset of the sample from perfect alignment</span>
<span class="s">        *back_reflectivity* is true if the beam enters through the substrate</span>

<span class="s">    Measurement properties are fittable parameters.  *theta_offset* in</span>
<span class="s">    particular should be set using probe.theta_offset.dev(dT), with dT</span>
<span class="s">    equal to the uncertainty in the peak position for the rocking curve,</span>
<span class="s">    as measured in radians.  Changes to *theta_offset* will then be penalized</span>
<span class="s">    in the cost function for the fit as if it were another measurement.  Use</span>
<span class="s">    :meth:`alignment_uncertainty` to compute dT from the shape of the</span>
<span class="s">    rocking curve.</span>

<span class="s">    *intensity* and *back_absorption* are generally not needed --- scaling</span>
<span class="s">    the reflected signal by an appropriate intensity measurement will correct</span>
<span class="s">    for both of these during reduction.  *background* may be needed,</span>
<span class="s">    particularly for samples with significant hydrogen content due to its</span>
<span class="s">    large isotropic incoherent scattering cross section.</span>

<span class="s">    View properties:</span>

<span class="s">        *substrate* is the material which makes up the substrate</span>
<span class="s">        *surface* is the material which makes up the surface</span>
<span class="s">        *view* is &#39;fresnel&#39;, &#39;log&#39;, &#39;linear&#39;, &#39;q4&#39;, &#39;residual&#39;</span>
<span class="s">        *plot_shift* is the number of pt to shift each new dataset</span>

<span class="s">    Normally *view* is set directly in the class rather than the</span>
<span class="s">    instance since it is not specific to the view.  The fresnel</span>
<span class="s">    substrate and surface materials are a property of the sample,</span>
<span class="s">    and should share the same material.</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">polarized</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Aguide</span> <span class="o">=</span> <span class="mf">270</span>  <span class="c"># default guide field for unpolarized measurements</span>
    <span class="n">view</span> <span class="o">=</span> <span class="s">&quot;fresnel&quot;</span>
    <span class="n">plot_shift</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">residuals_shift</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">substrate</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dT</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dL</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">intensity</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">back_absorption</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">theta_offset</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                 <span class="n">back_reflectivity</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">L</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;T and L required&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;intensity&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">background</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;background&quot;</span><span class="p">,</span>
                                            <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_absorption</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">back_absorption</span><span class="p">,</span>
                                                 <span class="n">name</span><span class="o">=</span><span class="s">&quot;back_absorption&quot;</span><span class="p">,</span>
                                                 <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">theta_offset</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;theta_offset&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="o">=</span> <span class="n">back_reflectivity</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_TLR</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_TLR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">):</span>
        <span class="c">#if L is None:</span>
        <span class="c">#    L = xsf.xray_wavelength(E)</span>
        <span class="c">#    dL = L * dE/E</span>
        <span class="c">#else:</span>
        <span class="c">#    E = xsf.xray_energy(L)</span>
        <span class="c">#    dE = E * dL/L</span>

        <span class="n">Q</span> <span class="o">=</span> <span class="n">TL2Q</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
        <span class="n">dQ</span> <span class="o">=</span> <span class="n">dTdL2dQ</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="o">=</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">)</span>

        <span class="c"># Make sure that we are dealing with vectors</span>
        <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span><span class="o">*</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">)]</span>

        <span class="c"># Probe stores sorted values for convenience of resolution calculator</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dT</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dL</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dL</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dQ</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">dR</span> <span class="o">=</span> <span class="n">dR</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">dR</span>

        <span class="c"># By default the calculated points are the measured points.  Use</span>
        <span class="c"># oversample() for a more accurate resolution calculations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Probe.alignment_uncertainty"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.alignment_uncertainty">[docs]</a>    <span class="k">def</span> <span class="nf">alignment_uncertainty</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="s">r&quot;&quot;&quot;</span>
<span class="s">        Compute alignment uncertainty.</span>

<span class="s">        **Parameters:**</span>

<span class="s">        *w* : float | degrees</span>
<span class="s">            Rocking curve full width at half max.</span>
<span class="s">        *I* : float | counts</span>
<span class="s">            Rocking curve integrated intensity.</span>
<span class="s">        *d* = 0: float | degrees</span>
<span class="s">            Motor step size</span>

<span class="s">        **Returns:**</span>

<span class="s">        *dtheta* : float | degrees</span>
<span class="s">            uncertainty in alignment angle</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="o">**</span><span class="mf">2</span><span class="o">/</span><span class="n">I</span> <span class="o">+</span> <span class="n">d</span><span class="o">**</span><span class="mf">2</span><span class="o">/</span><span class="mf">12.</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Probe.log10_to_linear"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.log10_to_linear">[docs]</a>    <span class="k">def</span> <span class="nf">log10_to_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert data from log to linear.</span>

<span class="sd">        Older reflectometry reduction code stored reflectivity in log base 10</span>
<span class="sd">        format.  Call probe.log10_to_linear() after loading this data to</span>
<span class="sd">        convert it to linear for subsequent display and fitting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="mf">10</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">Ro</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span>
</div>
    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span>
    <span class="k">def</span> <span class="nf">_set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c"># Setting data is dangerous since the Q points may have been</span>
        <span class="c"># reordered to keep them sorted.  The external user may be</span>
        <span class="c"># expecting to reset them from the original data file, which</span>
        <span class="c"># would fail, or from a simulation based on Q, which would</span>
        <span class="c"># succeed.  Storing the reordering vector wouldn&#39;t help since</span>
        <span class="c"># it would just reverse the problem and still lead to confusion.</span>
        <span class="c"># Returning self.Q in the original order would allow both cases</span>
        <span class="c"># to work, but it makes simulation more complicated because the</span>
        <span class="c"># resolution calculation wants sorted inputs.  We could just</span>
        <span class="c"># make the resolution calculation sort its inputs, but that</span>
        <span class="c"># increases the cost of computing the reflectivity curve (though</span>
        <span class="c"># that cost may small compared to the cost of sorting an almost</span>
        <span class="c"># sorted list).</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Remember the original so we can resynthesize as needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_data</span><span class="p">,</span> <span class="n">_set_data</span><span class="p">)</span>
<div class="viewcode-block" id="Probe.resynth_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.resynth_data">[docs]</a>    <span class="k">def</span> <span class="nf">resynth_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate new data according to the model R ~ N(Ro,dR).</span>

<span class="sd">        The resynthesis step is a precursor to refitting the data, as is</span>
<span class="sd">        required for certain types of monte carlo error analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Ro</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span>
</div>
<div class="viewcode-block" id="Probe.restore_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.restore_data">[docs]</a>    <span class="k">def</span> <span class="nf">restore_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore the original data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span>
</div>
<div class="viewcode-block" id="Probe.simulate_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.simulate_data">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the data for the probe to R, adding random noise dR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
        <span class="n">dR</span> <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">noise</span><span class="o">*</span><span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">R</span><span class="o">+</span><span class="mf">0</span><span class="p">,</span> <span class="n">dR</span><span class="o">+</span><span class="mf">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span><span class="p">[</span><span class="n">R</span><span class="o">==</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">[</span><span class="n">dR</span><span class="o">==</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resynth_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span>
</div>
<div class="viewcode-block" id="Probe.write_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.write_data">[docs]</a>    <span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                   <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="s">&#39;dR&#39;</span><span class="p">],</span>
                   <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data to a file.</span>

<span class="sd">        *header* is a string with trailing \\n containing the file header.</span>
<span class="sd">        *columns* is a list of column names from Q, dQ, R, dR, L, dL, T, dT.</span>

<span class="sd">        The default is to write Q,R,dR data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&quot;# </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_set_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">TL2Q</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_L</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_Qo</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c"># Only keep the scattering factors that you need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">TL2Q</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
            <span class="c">#TODO: this may break the Q order on measurements with varying L</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span>
        <span class="k">return</span> <span class="n">Q</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_Q</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_calc_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">TL2Q</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_T</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_L</span><span class="p">)</span>
            <span class="c">#TODO: this may break the Q order on measurements with varying L</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_Qo</span>
        <span class="k">return</span> <span class="n">Q</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="k">else</span> <span class="o">-</span><span class="n">Q</span>
    <span class="n">calc_Q</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_calc_Q</span><span class="p">)</span>
<div class="viewcode-block" id="Probe.parameters"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">intensity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
                    <span class="n">background</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
                    <span class="n">back_absorption</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">back_absorption</span><span class="p">,</span>
                    <span class="n">theta_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span><span class="p">)</span></div>
<div class="viewcode-block" id="Probe.scattering_factors"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.scattering_factors">[docs]</a>    <span class="k">def</span> <span class="nf">scattering_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the scattering factors associated with the material given</span>
<span class="sd">        the range of wavelengths/energies used in the probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of scattering factors that will be returned for</span>
<span class="sd">        the probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">)</span>

<div class="viewcode-block" id="Probe.subsample"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.subsample">[docs]</a>    <span class="k">def</span> <span class="nf">subsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dQ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select points at most every dQ.</span>

<span class="sd">        Use this to speed up computation early in the fitting process.</span>

<span class="sd">        This changes the data object, and is not reversible.</span>

<span class="sd">        The current algorithm is not picking the &quot;best&quot; Q value, just the</span>
<span class="sd">        nearest, so if you have nearby Q points with different quality</span>
<span class="sd">        statistics (as happens in overlapped regions from spallation</span>
<span class="sd">        source measurements at different angles), then it may choose</span>
<span class="sd">        badly.  Simple solutions based on the smallest relative error dR/R</span>
<span class="sd">        will be biased toward peaks, and smallest absolute error dR will</span>
<span class="sd">        be biased toward valleys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Assumes self contains sorted Qo and associated T,L</span>
        <span class="c"># Note: calc_Qo is already sorted</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">],</span><span class="n">dQ</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">,</span><span class="n">Q</span><span class="p">))</span>
        <span class="c">#print len(idx),len(self.Qo)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Probe.resolution_guard"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.resolution_guard">[docs]</a>    <span class="k">def</span> <span class="nf">resolution_guard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">r&quot;&quot;&quot;</span>
<span class="s">        Make sure each measured $Q$ point has at least 5 calculated $Q$</span>
<span class="s">        points contributing to it in the range $[-3\Delta Q,3\Delta Q]$.</span>

<span class="s">        *Not Implemented*</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c"># TODO: implement resolution guard.</span>
</div>
<div class="viewcode-block" id="Probe.critical_edge"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.critical_edge">[docs]</a>    <span class="k">def</span> <span class="nf">critical_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">n</span><span class="o">=</span><span class="mf">51</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
        <span class="s">r&quot;&quot;&quot;</span>
<span class="s">        Oversample points near the critical edge.</span>

<span class="s">        The critical edge is defined by the difference in scattering</span>
<span class="s">        potential for the *substrate* and *surface* materials, or the</span>
<span class="s">        reverse if *back_reflectivity* is true.</span>

<span class="s">        *n* is the number of $Q$ points to compute near the critical edge.</span>

<span class="s">        *delta* is the relative uncertainty in the material density,</span>
<span class="s">        which defines the range of values which are calculated.</span>

<span class="s">        The $n$ points $Q_i$ are evenly distributed around the critical</span>
<span class="s">        edge from $Q_c - \delta Q_c$ to $Q_c + \delta Q_c$ by varying</span>
<span class="s">        angle $\theta$ for a fixed wavelength $&lt; \lambda &gt;$, the average</span>
<span class="s">        of all wavelengths in the probe.</span>

<span class="s">        Specifically:</span>

<span class="s">        .. math::</span>

<span class="s">            Q_c^2 &amp;= 16 \pi (\rho - \rho_{\text incident}) \\</span>
<span class="s">            Q_i &amp;= Q_c - \delta_i Q_c (i - (n-1)/2)  \forall i \in 0 \ldots n-1 \\</span>
<span class="s">            \lambda_i &amp;= &lt; \lambda &gt; \\</span>
<span class="s">            \theta_i &amp;= \sin^-1(Q_i \lambda_i / 4 \pi)</span>

<span class="s">        If $Q_c$ is imaginary, then $-|Q_c|$ is used instead, so this</span>
<span class="s">        routine can be used for reflectivity signals which scan from</span>
<span class="s">        back reflectivity to front reflectivity.  For completeness,</span>
<span class="s">        the angle $\theta = 0$ is added as well.</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">Srho</span><span class="p">,</span><span class="n">Sirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">substrate</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">Vrho</span><span class="p">,</span><span class="n">Virho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">surface</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">drho</span> <span class="o">=</span> <span class="n">Srho</span><span class="o">-</span><span class="n">Vrho</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="k">else</span> <span class="n">Vrho</span><span class="o">-</span><span class="n">Srho</span>
        <span class="n">Q_c</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">drho</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">16</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">drho</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Q_c</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">),</span> <span class="n">Q_c</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">delta</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">QL2T</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="mf">0</span><span class="p">))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,[</span><span class="n">L</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mf">1</span><span class="p">)))</span>
        <span class="c">#print Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Probe.oversample"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.oversample">[docs]</a>    <span class="k">def</span> <span class="nf">oversample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an over-sampling of Q to avoid aliasing effects.</span>

<span class="sd">        Oversampling is needed for thick layers, in which the underlying</span>
<span class="sd">        reflectivity oscillates so rapidly in Q that a single measurement</span>
<span class="sd">        has contributions from multiple Kissig fringes.</span>

<span class="sd">        Sampling will be done using a pseudo-random generator so that</span>
<span class="sd">        accidental structure in the function does not contribute to the</span>
<span class="sd">        aliasing.  The generator will usually be initialized with a fixed</span>
<span class="sd">        *seed* so that the point selection will not change from run to run,</span>
<span class="sd">        but a *seed* of None will choose a different set of points each time</span>
<span class="sd">        oversample is called.</span>

<span class="sd">        The value *n* is the number of points that should contribute to</span>
<span class="sd">        each Q value when computing the resolution.   These will be</span>
<span class="sd">        distributed about the nominal measurement value, but varying in</span>
<span class="sd">        both angle and energy according to the resolution function.  This</span>
<span class="sd">        will yield more points near the measurement and fewer farther away.</span>
<span class="sd">        The measurement point itself will not be used to avoid accidental</span>
<span class="sd">        bias from uniform Q steps.  Depending on the problem, a value of</span>
<span class="sd">        *n* between 20 and 100 should lead to stable values for the convolved</span>
<span class="sd">        reflectivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">&lt;=</span><span class="mf">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Oversampling with n&lt;=5 is not useful&quot;</span><span class="p">)</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">),</span><span class="n">n</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">),</span><span class="n">n</span><span class="o">-</span><span class="mf">1</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_apply_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">Rin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the instrument resolution function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">convolve</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">Rin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">)</span>

<div class="viewcode-block" id="Probe.apply_beam"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.apply_beam">[docs]</a>    <span class="k">def</span> <span class="nf">apply_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply factors such as beam intensity, background, backabsorption,</span>
<span class="sd">        resolution to the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Note: in-place vector operations are not notably faster.</span>

        <span class="c"># Handle absorption through the substrate, which occurs when Q&lt;0</span>
        <span class="c"># (condition)*C is C when condition is True or 0 when False,</span>
        <span class="c"># (condition)*(C-1)+1 is C when condition is True or 1 when False.</span>
        <span class="n">back</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc_Q</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">back_absorption</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">+</span><span class="mf">1</span>
        <span class="n">calc_R</span> <span class="o">=</span> <span class="n">calc_R</span> <span class="o">*</span> <span class="n">back</span>

        <span class="c"># For back reflectivity, reverse the sign of Q after computing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span><span class="p">:</span>
            <span class="n">calc_Q</span> <span class="o">=</span> <span class="o">-</span><span class="n">calc_Q</span>
        <span class="k">if</span> <span class="n">calc_Q</span><span class="p">[</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">calc_Q</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
            <span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resolution</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_resolution</span><span class="p">(</span><span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Given that the target Q points should be in the set of</span>
            <span class="c"># calculated Q values, interp will give us the</span>
            <span class="c"># values of Q at the appropriate R, even if there are</span>
            <span class="c"># guard values, or otherwise some mixture of calculated</span>
            <span class="c"># Q values.  The cost of doing so is going to be n log n</span>
            <span class="c"># in the size of Q, which is a bit pricey, but let&#39;s see</span>
            <span class="c"># if it is a problem before optimizing.</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">R</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">,</span><span class="n">R</span>
</div>
<div class="viewcode-block" id="Probe.fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the reflectivity for the probe reflecting from a block of</span>
<span class="sd">        material with the given substrate.</span>

<span class="sd">        Returns F = R(probe.Q), where R is magnitude squared reflectivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Doesn&#39;t use ProbeCache, but this routine is not time critical</span>
        <span class="n">Srho</span><span class="p">,</span><span class="n">Sirho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">substrate</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">Vrho</span><span class="p">,</span><span class="n">Virho</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">surface</span><span class="o">.</span><span class="n">sld</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:</span><span class="mf">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span><span class="p">:</span>
            <span class="n">Srho</span><span class="p">,</span><span class="n">Vrho</span> <span class="o">=</span> <span class="n">Vrho</span><span class="p">,</span><span class="n">Srho</span>
            <span class="n">Sirho</span><span class="p">,</span><span class="n">Virho</span> <span class="o">=</span> <span class="n">Virho</span><span class="p">,</span><span class="n">Sirho</span>
        <span class="k">if</span> <span class="n">Srho</span> <span class="o">==</span> <span class="n">Vrho</span><span class="p">:</span> <span class="n">Srho</span> <span class="o">=</span> <span class="n">Vrho</span> <span class="o">+</span> <span class="mf">1</span>
        <span class="c">#I = numpy.ones_like(self.Q)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">fresnel</span><span class="o">.</span><span class="n">Fresnel</span><span class="p">(</span><span class="n">rho</span><span class="o">=</span><span class="n">Srho</span><span class="o">*</span><span class="n">I</span><span class="p">,</span> <span class="n">irho</span><span class="o">=</span><span class="n">Sirho</span><span class="o">*</span><span class="n">I</span><span class="p">,</span>
                                     <span class="n">Vrho</span><span class="o">=</span><span class="n">Vrho</span><span class="o">*</span><span class="n">I</span><span class="p">,</span> <span class="n">Virho</span><span class="o">=</span><span class="n">Virho</span><span class="o">*</span><span class="n">I</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculator</span>
</div>
<div class="viewcode-block" id="Probe.save"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data and theory to a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fresnel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresnel</span><span class="p">(</span><span class="n">substrate</span><span class="p">,</span> <span class="n">surface</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">fresnel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# </span><span class="si">%17s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="o">%</span><span class="p">(</span><span class="s">&quot;Q (1/A)&quot;</span><span class="p">,</span><span class="s">&quot;dQ (1/A)&quot;</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;dR&quot;</span><span class="p">,</span> <span class="s">&quot;theory&quot;</span><span class="p">,</span> <span class="s">&quot;fresnel&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">fresnel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)))</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# </span><span class="si">%17s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%20s</span><span class="se">\n</span><span class="s">&quot;</span>
                      <span class="o">%</span><span class="p">(</span><span class="s">&quot;Q (1/A)&quot;</span><span class="p">,</span><span class="s">&quot;dQ (1/A)&quot;</span><span class="p">,</span> <span class="s">&quot;theory&quot;</span><span class="p">,</span> <span class="s">&quot;fresnel&quot;</span><span class="p">))</span>
        <span class="c">#print &quot;A&quot;,self.Q.shape,A.shape</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%20.15g</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Probe.plot"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot theory against data.</span>

<span class="sd">        Need substrate/surface for Fresnel reflectivity</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">view</span> <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span>

        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;linear&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_linear</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;log&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_log</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;fresnel&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fresnel</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;q4&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_Q4</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;resolution&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_resolution</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;residual&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;fft&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fft</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;SA&#39;</span><span class="p">:</span> <span class="c"># SA uses default plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;incorrect reflectivity view &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">view</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Probe.plot_resolution"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">plot_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;Q ($\AA^{-1}$)&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;Q resolution ($1-\sigma \AA^{-1}$)&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Measurement resolution&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Probe.plot_linear"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_linear">[docs]</a>    <span class="k">def</span> <span class="nf">plot_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the data associated with probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pair</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&#39;Reflectivity&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">&#39;linear&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Probe.plot_log"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_log">[docs]</a>    <span class="k">def</span> <span class="nf">plot_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the data associated with probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pair</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&#39;Reflectivity&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Probe.plot_fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Fresnel reflectivity associated with the probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Fresnel reflectivity needs substrate or surface&quot;</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresnel</span><span class="p">(</span><span class="n">substrate</span><span class="o">=</span><span class="n">substrate</span><span class="p">,</span><span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Q</span><span class="p">:</span> <span class="mf">1.</span><span class="o">/</span><span class="n">F</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;air:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">surface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span><span class="n">Vacuum</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">substrate</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">substrate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">surface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pair</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s">&#39;R/R(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Probe.plot_Q4"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_Q4">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Q4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the Q**4 reflectivity associated with the probe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Q</span><span class="p">:</span> <span class="mf">1e8</span><span class="o">*</span><span class="n">Q</span><span class="o">**</span><span class="mf">4</span>
        <span class="c">#Q4[Q4==0] = 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pair</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s">&#39;R (100 Q)^4&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_plot_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="k">lambda</span> <span class="n">Q</span><span class="p">:</span> <span class="mf">1</span><span class="p">,</span>
                   <span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">plot_shift</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coordinated_colors</span><span class="p">()</span>
        <span class="n">isheld</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ishold</span><span class="p">()</span>
        <span class="n">plot_shift</span> <span class="o">=</span> <span class="n">plot_shift</span> <span class="k">if</span> <span class="n">plot_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_shift</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">auto_shift</span><span class="p">(</span><span class="n">plot_shift</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">yerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="o">*</span><span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                           <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dQ</span><span class="p">,</span>
                           <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">gloss</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span>
                                            <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">*</span><span class="n">scale</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;dark&#39;</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">gloss</span><span class="o">=</span><span class="s">&#39;theory&#39;</span><span class="p">,</span>
                                        <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">isheld</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Q (inv Angstroms)&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="c">#pylab.legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">get_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<div class="viewcode-block" id="Probe.plot_residuals"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">plot_shift</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">plot_shift</span> <span class="o">=</span> <span class="n">plot_shift</span> <span class="k">if</span> <span class="n">plot_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">Probe</span><span class="o">.</span><span class="n">residuals_shift</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">auto_shift</span><span class="p">(</span><span class="n">plot_shift</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">coordinated_colors</span><span class="p">()</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span>
                       <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">],</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Q (inv A)&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;(theory-data)/error&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Probe.plot_fft"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.plot_fft">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FFT analysis of reflectivity signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coordinated_colors</span><span class="p">()</span>
        <span class="n">isheld</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ishold</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;FFT reflectivity needs substrate or surface&quot;</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresnel</span><span class="p">(</span><span class="n">substrate</span><span class="o">=</span><span class="n">substrate</span><span class="p">,</span><span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">)</span>
        <span class="c">#Qc = sqrt(16*pi*substrate)</span>
        <span class="n">Qc</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="n">Qmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Qc</span><span class="p">,</span><span class="n">Qmax</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">))</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">Qmax</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span><span class="o">//</span><span class="mf">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="n">F</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">signal</span><span class="p">)))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">//</span><span class="mf">2</span><span class="p">]</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="s">&#39;.-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">],</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">gloss</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">,</span>
                                        <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="o">/</span><span class="n">F</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">signal</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">signal</span><span class="p">)))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">//</span><span class="mf">2</span><span class="p">]</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;dark&#39;</span><span class="p">],</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">gloss</span><span class="o">=</span><span class="s">&#39;theory&#39;</span><span class="p">,</span>
                                        <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">))</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">isheld</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;w (A)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">substrate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;air:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">surface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span><span class="n">Vacuum</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">substrate</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">substrate</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">surface</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;|FFT(R/R(</span><span class="si">%s</span><span class="s">))|&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Probe.label"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.label">[docs]</a>    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gloss</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">prefix</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span><span class="n">gloss</span><span class="p">))</span> <span class="k">if</span> <span class="n">gloss</span> <span class="k">else</span> <span class="n">prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">suffix</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">gloss</span> <span class="k">if</span> <span class="n">gloss</span> <span class="k">else</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Probe.name"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Probe.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="XrayProbe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.XrayProbe">[docs]</a><span class="k">class</span> <span class="nc">XrayProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    X-Ray probe.</span>

<span class="sd">    Contains information about the kind of probe used to investigate</span>
<span class="sd">    the sample.</span>

<span class="sd">    X-ray data is traditionally recorded by angle and energy, rather</span>
<span class="sd">    than angle and wavelength as is used by neutron probes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="XrayProbe.scattering_factors"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.XrayProbe.scattering_factors">[docs]</a>    <span class="k">def</span> <span class="nf">scattering_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="c"># doc string is inherited from parent (see below)</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span> <span class="o">=</span> <span class="n">xsf</span><span class="o">.</span><span class="n">xray_sld</span><span class="p">(</span><span class="n">material</span><span class="p">,</span>
                                 <span class="n">wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">,</span>
                                 <span class="n">density</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="c"># TODO: support wavelength dependent systems</span>
        <span class="k">return</span> <span class="n">rho</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">irho</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="mf">0</span>
        <span class="k">return</span> <span class="n">rho</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span><span class="p">],</span> <span class="n">irho</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span><span class="p">],</span> <span class="mf">0</span></div>
    <span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span>
</div>
<div class="viewcode-block" id="NeutronProbe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.NeutronProbe">[docs]</a><span class="k">class</span> <span class="nc">NeutronProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
<div class="viewcode-block" id="NeutronProbe.scattering_factors"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.NeutronProbe.scattering_factors">[docs]</a>    <span class="k">def</span> <span class="nf">scattering_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="c"># doc string is inherited from parent (see below)</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">,</span> <span class="n">rho_incoh</span> <span class="o">=</span> <span class="n">nsf</span><span class="o">.</span><span class="n">neutron_sld</span><span class="p">(</span><span class="n">material</span><span class="p">,</span>
                                               <span class="n">wavelength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">,</span>
                                               <span class="n">density</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="c"># TODO: support wavelength dependent systems</span>
        <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">rho_incoh</span>
        <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span><span class="p">],</span> <span class="n">rho_incoh</span></div>
    <span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span>


</div>
<div class="viewcode-block" id="ProbeSet"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet">[docs]</a><span class="k">class</span> <span class="nc">ProbeSet</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">probes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">R</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dR</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dQ</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">])</span>

        <span class="n">back_refls</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all</span><span class="p">(</span><span class="n">back_refls</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">any</span><span class="p">(</span><span class="n">back_refls</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="o">=</span> <span class="n">back_refls</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot mix front and back reflectivity measurements&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ProbeSet.parameters"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">]</span></div>
    <span class="n">parameters</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="ProbeSet.resynth_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.resynth_data">[docs]</a>    <span class="k">def</span> <span class="nf">resynth_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">resynth_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">R</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span></div>
    <span class="n">resynth_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">resynth_data</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="ProbeSet.restore_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.restore_data">[docs]</a>    <span class="k">def</span> <span class="nf">restore_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">restore_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">R</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span></div>
    <span class="n">restore_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">restore_data</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="ProbeSet.simulate_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.simulate_data">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">2</span><span class="p">):</span>
        <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">simulate_data</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">n</span><span class="p">],</span><span class="n">R</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">n</span><span class="p">]),</span>
                            <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">n</span></div>
    <span class="n">simulate_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">simulate_data</span><span class="o">.</span><span class="n">__doc__</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>
    <span class="k">def</span> <span class="nf">_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Q</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_Q</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_calc_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">calc_Q</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">))</span>
    <span class="n">calc_Q</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_calc_Q</span><span class="p">)</span>
<div class="viewcode-block" id="ProbeSet.oversample"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.oversample">[docs]</a>    <span class="k">def</span> <span class="nf">oversample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">oversample</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">oversample</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">oversample</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.scattering_factors"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.scattering_factors">[docs]</a>    <span class="k">def</span> <span class="nf">scattering_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">scattering_factors</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">scattering_factors</span><span class="p">(</span><span class="n">material</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)]</span></div>
    <span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.apply_beam"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.apply_beam">[docs]</a>    <span class="k">def</span> <span class="nf">apply_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">apply_beam</span><span class="p">(</span><span class="n">calc_Q</span><span class="p">,</span> <span class="n">calc_R</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">]</span>
        <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">,</span><span class="n">R</span></div>
<div class="viewcode-block" id="ProbeSet.fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">fresnel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">fresnel</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">fresnel</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.save"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">p</span><span class="p">,</span><span class="n">th</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">theory</span><span class="p">)):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">),</span> <span class="n">th</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="n">substrate</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">)</span></div>
    <span class="n">save</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="n">ishold</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ishold</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">ishold</span><span class="p">)</span></div>
    <span class="n">plot</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_resolution"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">plot_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_resolution</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_resolution</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_resolution</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_linear"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_linear">[docs]</a>    <span class="k">def</span> <span class="nf">plot_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_linear</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_linear</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_linear</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_log"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_log">[docs]</a>    <span class="k">def</span> <span class="nf">plot_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_log</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_log</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_log</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_fresnel</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_fresnel</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_fresnel</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_Q4"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_Q4">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Q4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_Q4</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_Q4</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_Q4</span><span class="o">.</span><span class="n">__doc__</span>
<div class="viewcode-block" id="ProbeSet.plot_residuals"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.plot_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">(</span><span class="n">theory</span><span class="p">):</span> <span class="n">p</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">plot_residuals</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_residuals</span><span class="o">.</span><span class="n">__doc__</span>
    <span class="k">def</span> <span class="nf">_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">p</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">theory</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">p</span><span class="p">,(</span><span class="n">Q</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">n</span><span class="p">],</span><span class="n">R</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">n</span>

<div class="viewcode-block" id="ProbeSet.shared_beam"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.shared_beam">[docs]</a>    <span class="k">def</span> <span class="nf">shared_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                    <span class="n">back_absorption</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">theta_offset</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Share beam parameters across all segments.</span>

<span class="sd">        New parameters are created for *intensity*, *background*,</span>
<span class="sd">        *theta_offset* and *back_absorption* and assigned to the all</span>
<span class="sd">        segments.  These can be replaced in an individual segment if</span>
<span class="sd">        that parameter is independent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;intensity&quot;</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">background</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;background&quot;</span><span class="p">,</span>
                                       <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">])</span>
        <span class="n">back_absorption</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">back_absorption</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s">&quot;back_absorption&quot;</span><span class="p">,</span>
                                            <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">])</span>
        <span class="n">theta_offset</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">theta_offset</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;theta_offset&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
            <span class="n">p</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">background</span>
            <span class="n">p</span><span class="o">.</span><span class="n">back_absorption</span> <span class="o">=</span> <span class="n">back_absorption</span>
            <span class="n">p</span><span class="o">.</span><span class="n">theta_offset</span> <span class="o">=</span> <span class="n">theta_offset</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="ProbeSet.name"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</div>
<div class="viewcode-block" id="ProbeSet.stitch"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.ProbeSet.stitch">[docs]</a>    <span class="k">def</span> <span class="nf">stitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">same_Q</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">same_dQ</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="s">r&quot;&quot;&quot;</span>
<span class="s">        Stitch together multiple datasets into a single dataset.</span>

<span class="s">        Points within *tol* of each other and with the same resolution</span>
<span class="s">        are combined by interpolating them to a common $Q$ value then averaged</span>
<span class="s">        using Gaussian error propagation.</span>

<span class="s">        :Returns: probe | Probe</span>
<span class="s">            Combined data set.</span>

<span class="s">        :Algorithm:</span>

<span class="s">        To interpolate a set of points to a common value, first find the</span>
<span class="s">        common $Q$ value:</span>

<span class="s">        .. math::</span>

<span class="s">            \hat Q = \sum{Q_k} / n</span>

<span class="s">        Then for each dataset $k$, find the interval $[i,i+1]$ containing the</span>
<span class="s">        value $Q$, and use it to compute interpolated value for $R$:</span>

<span class="s">        .. math::</span>

<span class="s">            w &amp;= (\hat Q - Q_i)/(Q_{i+1} - Q_i) \\</span>
<span class="s">            \hat R &amp;= w R_{i+1} + (1-w) R_{i+1} \\</span>
<span class="s">            \hat \sigma_{R} &amp;=</span>
<span class="s">                \sqrt{ w^2 \sigma^2_{R_i} + (1-w)^2 \sigma^2_{R_{i+1}} } / n</span>

<span class="s">        Average the resulting $R$ using Gaussian error propagation:</span>

<span class="s">        .. math::</span>

<span class="s">            \hat R &amp;= \sum{\hat R_k}/n \\</span>
<span class="s">            \hat \sigma_R &amp;= \sqrt{\sum \hat \sigma_{R_k}^2}/n</span>

<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="n">stitch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">)</span>
        <span class="n">Po</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">QProbe</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">dQ</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">dR</span><span class="p">),</span>
                      <span class="n">intensity</span><span class="o">=</span><span class="n">Po</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
                      <span class="n">background</span><span class="o">=</span><span class="n">Po</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
                      <span class="n">back_absorption</span><span class="o">=</span><span class="n">Po</span><span class="o">.</span><span class="n">back_absorption</span><span class="p">,</span>
                      <span class="n">back_reflectivity</span><span class="o">=</span><span class="n">Po</span><span class="o">.</span><span class="n">back_reflectivity</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="QProbe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.QProbe">[docs]</a><span class="k">class</span> <span class="nc">QProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A pure Q,R probe</span>

<span class="sd">    This probe with no possibility of tricks such as looking up the</span>
<span class="sd">    scattering length density based on wavelength, or adjusting for</span>
<span class="sd">    alignment errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">dQ</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">intensity</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span> <span class="n">back_absorption</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span>
                 <span class="n">back_reflectivity</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;intensity&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">background</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;background&quot;</span><span class="p">,</span>
                                            <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_absorption</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">back_absorption</span><span class="p">,</span>
                                                 <span class="n">name</span><span class="o">=</span><span class="s">&quot;back_absorption&quot;</span><span class="p">,</span>
                                                 <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_offset</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;theta_offset&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="o">=</span> <span class="n">back_reflectivity</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Q</span><span class="p">,</span> <span class="n">dQ</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span><span class="p">,</span><span class="n">dR</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Qo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">dR</span>

</div>
<div class="viewcode-block" id="measurement_union"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.measurement_union">[docs]</a><span class="k">def</span> <span class="nf">measurement_union</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the unique (T,dT,L,dL) across all datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># First gather a set of unique tuples in angle and wavelength</span>
    <span class="n">TL</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">TL</span> <span class="o">=</span> <span class="n">TL</span> <span class="o">|</span> <span class="n">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">dT</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">L</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">dL</span><span class="p">))</span>
    <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">TL</span><span class="p">])</span>
    <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">]</span>

    <span class="c"># Convert to Q,dQ</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">TL2Q</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
    <span class="n">dQ</span> <span class="o">=</span> <span class="n">dTdL2dQ</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">)</span>

    <span class="c"># Sort by Q</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dT</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">L</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dL</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dQ</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dQ</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Q</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Q is not unique&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">dQ</span>
</div>
<div class="viewcode-block" id="Qmeasurement_union"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.Qmeasurement_union">[docs]</a><span class="k">def</span> <span class="nf">Qmeasurement_union</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the unique (T,dT,L,dL) across all datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Qset</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Qset</span> <span class="o">=</span> <span class="n">Qset</span> <span class="o">|</span> <span class="n">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">dQ</span><span class="p">))</span>
    <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">Qset</span><span class="p">])]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">Q</span><span class="p">,</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">dQ</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mf">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Q</span><span class="p">[:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-14</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Q is not unique&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">dQ</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe">[docs]</a><span class="k">class</span> <span class="nc">PolarizedNeutronProbe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Polarized neutron probe</span>

<span class="sd">    *xs* (4 x NeutronProbe) is a sequence pp, pm, mp and mm.</span>
<span class="sd">    *Aguide* (degrees) is the angle of the guide field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">view</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># Default to Probe.view so only need to change in one place</span>
    <span class="n">substrate</span> <span class="o">=</span> <span class="n">surface</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">polarized</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Aguide</span><span class="o">=</span><span class="mf">270</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> \
            <span class="o">=</span> <span class="n">measurement_union</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Aguide</span> <span class="o">=</span> <span class="n">Aguide</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.pp"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.pp">[docs]</a>    <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.pm"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.pm">[docs]</a>    <span class="k">def</span> <span class="nf">pm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.mp"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.mp">[docs]</a>    <span class="k">def</span> <span class="nf">mp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.mm"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.mm">[docs]</a>    <span class="k">def</span> <span class="nf">mm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe.parameters"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pp</span><span class="p">,</span><span class="n">pm</span><span class="p">,</span><span class="n">mp</span><span class="p">,</span><span class="n">mm</span> <span class="o">=</span> <span class="p">[(</span><span class="n">xsi</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">xsi</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">xsi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pp</span><span class="o">=</span><span class="n">pp</span><span class="p">,</span> <span class="n">pm</span><span class="o">=</span><span class="n">pm</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span> <span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe.resynth_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.resynth_data">[docs]</a>    <span class="k">def</span> <span class="nf">resynth_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">resynth_data</span><span class="p">()</span></div>
    <span class="n">resynth_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">resynth_data</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.restore_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.restore_data">[docs]</a>    <span class="k">def</span> <span class="nf">restore_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">restore_data</span><span class="p">()</span></div>
    <span class="n">restore_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">restore_data</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.simulate_data"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.simulate_data">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">th</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span><span class="n">theory</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">simulate_data</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span></div>
    <span class="n">simulate_data</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">simulate_data</span><span class="o">.</span><span class="n">__doc__</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">back_refls</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all</span><span class="p">(</span><span class="n">back_refls</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">any</span><span class="p">(</span><span class="n">back_refls</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">back_reflectivity</span> <span class="o">=</span> <span class="n">back_refls</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot mix front and back reflectivity measurements&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.shared_beam"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.shared_beam">[docs]</a>    <span class="k">def</span> <span class="nf">shared_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span>
                    <span class="n">back_absorption</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">theta_offset</span><span class="o">=</span><span class="mf">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Share beam parameters across all four cross sections.</span>

<span class="sd">        New parameters are created for *intensity*, *background*,</span>
<span class="sd">        *theta_offset* and *back_absorption* and assigned to the all</span>
<span class="sd">        cross sections.  These can be replaced in an individual</span>
<span class="sd">        cross section if for some reason one of the parameters is</span>
<span class="sd">        independent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;intensity&quot;</span><span class="p">)</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">background</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;background&quot;</span><span class="p">,</span>
                                       <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="n">inf</span><span class="p">])</span>
        <span class="n">back_absorption</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">back_absorption</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s">&quot;back_absorption&quot;</span><span class="p">,</span>
                                            <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">])</span>
        <span class="n">theta_offset</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">theta_offset</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;theta_offset&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
                <span class="n">x</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">background</span>
                <span class="n">x</span><span class="o">.</span><span class="n">back_absorption</span> <span class="o">=</span> <span class="n">back_absorption</span>
                <span class="n">x</span><span class="o">.</span><span class="n">theta_offset</span> <span class="o">=</span> <span class="n">theta_offset</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe.oversample"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.oversample">[docs]</a>    <span class="k">def</span> <span class="nf">oversample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mf">6</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
        <span class="c"># doc string is inherited from parent (see below)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">),</span><span class="n">n</span><span class="p">))</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">[:,</span><span class="bp">None</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dL</span><span class="p">),</span><span class="n">n</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">L</span><span class="p">)</span></div>
    <span class="n">oversample</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">oversample</span><span class="o">.</span><span class="n">__doc__</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.calc_Q"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.calc_Q">[docs]</a>    <span class="k">def</span> <span class="nf">calc_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># All calc_Q should be the same, so return the first one</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">calc_Q</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;No polarization cross sections&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_set_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate setting of calc_Q to the individual cross sections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Set all xs to have the same calc_Q</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">_set_calc</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
        <span class="c"># Only keep the scattering factors that you need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.apply_beam"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.apply_beam">[docs]</a>    <span class="k">def</span> <span class="nf">apply_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply factors such as beam intensity, background, backabsorption,</span>
<span class="sd">        and footprint to the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">xs</span><span class="o">.</span><span class="n">apply_beam</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Ri</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span> <span class="k">if</span> <span class="n">xs</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xs</span><span class="p">,</span><span class="n">Ri</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span><span class="n">R</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe.fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">fresnel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
    <span class="n">fresnel</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">fresnel</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.scattering_factors"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.scattering_factors">[docs]</a>    <span class="k">def</span> <span class="nf">scattering_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="c"># doc string is inherited from parent (see below)</span>
        <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">,</span> <span class="n">rho_incoh</span> <span class="o">=</span> <span class="n">nsf</span><span class="o">.</span><span class="n">neutron_sld</span><span class="p">(</span><span class="n">material</span><span class="p">,</span>
                                               <span class="n">wavelength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_L</span><span class="p">,</span>
                                               <span class="n">density</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rho</span><span class="p">,</span> <span class="n">irho</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sf_idx</span><span class="p">],</span> <span class="n">rho_incoh</span></div>
    <span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">scattering_factors</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.select_corresponding"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.select_corresponding">[docs]</a>    <span class="k">def</span> <span class="nf">select_corresponding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select theory points corresponding to the measured data.</span>

<span class="sd">        Since we have evaluated theory at every Q, it is safe to interpolate</span>
<span class="sd">        measured Q into theory, since it will land on a node,</span>
<span class="sd">        not in an interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Qth</span><span class="p">,</span><span class="n">Rth</span> <span class="o">=</span> <span class="n">theory</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">None</span> <span class="k">if</span> <span class="n">x_data</span> <span class="ow">is</span> <span class="bp">None</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">x_data</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_data</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="n">Qth</span><span class="p">,</span><span class="n">x_th</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">x_data</span><span class="p">,</span><span class="n">x_th</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span><span class="n">Rth</span><span class="p">)]</span>

</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_Q</span><span class="p">)</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.save"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">substrate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">xsi</span><span class="p">,</span><span class="n">xsi_th</span><span class="p">,</span><span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;D&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">xsi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">xsi</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="n">suffix</span><span class="p">,</span> <span class="n">xsi_th</span><span class="p">,</span>
                         <span class="n">substrate</span><span class="o">=</span><span class="n">substrate</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="n">surface</span><span class="p">)</span></div>
    <span class="n">save</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">__doc__</span>

<div class="viewcode-block" id="PolarizedNeutronProbe.plot"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot theory against data.</span>

<span class="sd">        Need substrate/surface for Fresnel reflectivity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">view</span> <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span>

        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">view</span> <span class="o">=</span> <span class="n">Probe</span><span class="o">.</span><span class="n">view</span>  <span class="c"># Default to Probe.view</span>

        <span class="k">if</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;linear&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_linear</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;log&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_log</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;fresnel&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fresnel</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;q4&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_Q4</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;residual&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;SA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_SA</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view</span> <span class="o">==</span> <span class="s">&#39;resolution&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_resolution</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;incorrect reflectivity view &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">view</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_resolution"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">plot_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_resolution&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_linear"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_linear">[docs]</a>    <span class="k">def</span> <span class="nf">plot_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_log"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_log">[docs]</a>    <span class="k">def</span> <span class="nf">plot_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_log&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_fresnel"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_fresnel">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fresnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_fresnel&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_Q4"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_Q4">[docs]</a>    <span class="k">def</span> <span class="nf">plot_Q4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_Q4&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_residuals"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xs_plot</span><span class="p">(</span><span class="s">&#39;plot_residuals&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="PolarizedNeutronProbe.plot_SA"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.plot_SA">[docs]</a>    <span class="k">def</span> <span class="nf">plot_SA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot_shift</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;cannot form spin asymmetry plot without ++ and --&quot;</span><span class="p">)</span>

        <span class="n">plot_shift</span> <span class="o">=</span> <span class="n">plot_shift</span> <span class="k">if</span> <span class="n">plot_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">Probe</span><span class="o">.</span><span class="n">plot_shift</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">auto_shift</span><span class="p">(</span><span class="n">plot_shift</span><span class="p">)</span>
        <span class="n">isheld</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ishold</span><span class="p">()</span>
        <span class="n">pp</span><span class="p">,</span><span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mm</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coordinated_colors</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">):</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">SA</span><span class="p">,</span><span class="n">dSA</span> <span class="o">=</span> <span class="n">spin_asymmetry</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="n">pp</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">pp</span><span class="o">.</span><span class="n">dR</span><span class="p">,</span><span class="n">mm</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span><span class="n">mm</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">mm</span><span class="o">.</span><span class="n">dR</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dSA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">dSA</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">dQ</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span>
                               <span class="n">label</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">gloss</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">),</span>
                               <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">SA</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">gloss</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">),</span>
                               <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;light&#39;</span><span class="p">])</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pp</span><span class="p">,</span><span class="n">pm</span><span class="p">,</span><span class="n">mp</span><span class="p">,</span><span class="n">mm</span> <span class="o">=</span> <span class="n">theory</span>
            <span class="n">Q</span><span class="p">,</span><span class="n">SA</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">spin_asymmetry</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">pp</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="n">mm</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">mm</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">gloss</span><span class="o">=</span><span class="s">&#39;theory&#39;</span><span class="p">),</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s">&#39;dark&#39;</span><span class="p">])</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="n">isheld</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;Q (\AA^{-1})&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;spin asymmetry $(R^{++} -\, R^{--}) / (R^{++} +\, R^{--})$&#39;</span><span class="p">)</span>
        <span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_xs_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotter</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pylab</span>
        <span class="c"># Plot available cross sections</span>
        <span class="n">isheld</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">ishold</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">theory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">theory</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x_data</span><span class="p">,</span><span class="n">x_th</span><span class="p">,</span><span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span>
                                      <span class="p">(</span><span class="s">&#39;$^{++}$&#39;</span><span class="p">,</span><span class="s">&#39;$^{+-}$&#39;</span><span class="p">,</span><span class="s">&#39;$^{-+}$&#39;</span><span class="p">,</span><span class="s">&#39;$^{--}$&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">x_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">plotter</span><span class="p">)</span>
                <span class="n">fn</span><span class="p">(</span><span class="n">theory</span><span class="o">=</span><span class="n">x_th</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isheld</span><span class="p">:</span> <span class="n">pylab</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PolarizedNeutronProbe.name"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronProbe.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span>
</div></div>
<div class="viewcode-block" id="spin_asymmetry"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.spin_asymmetry">[docs]</a><span class="k">def</span> <span class="nf">spin_asymmetry</span><span class="p">(</span><span class="n">Qp</span><span class="p">,</span><span class="n">Rp</span><span class="p">,</span><span class="n">dRp</span><span class="p">,</span><span class="n">Qm</span><span class="p">,</span><span class="n">Rm</span><span class="p">,</span><span class="n">dRm</span><span class="p">):</span>
    <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    Compute spin asymmetry for R++, R--.</span>

<span class="s">    **Parameters:**</span>

<span class="s">    *Qp*, *Rp*, *dRp* : vector</span>
<span class="s">        Measured ++ cross section and uncertainty.</span>
<span class="s">    *Qm*, *Rm*, *dRm* : vector</span>
<span class="s">        Measured -- cross section and uncertainty.</span>

<span class="s">    If *dRp*, *dRm* are None then the returned uncertainty will also be None.</span>

<span class="s">    **Returns:**</span>

<span class="s">    *Q*, *SA*, *dSA* : vector</span>
<span class="s">        Computed spin asymmetry and uncertainty.</span>

<span class="s">    **Algorithm:**</span>

<span class="s">    Spin asymmetry, $S_A$, is:</span>

<span class="s">    .. math::</span>

<span class="s">        S_A = \frac{R_{++} - R_{--}}{R_{++} + R_{--}}</span>

<span class="s">    Uncertainty $\Delta S_A$ follows from propagation of error:</span>

<span class="s">    .. math::</span>

<span class="s">        \Delta S_A^2 = \frac{4(R_{++}^2\Delta R_{--}^2+R_{--}^2\Delta R_{++})}</span>
<span class="s">                            {(R_{++} + R_{--})^4}</span>

<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">Rm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Qp</span><span class="p">,</span><span class="n">Qm</span><span class="p">,</span><span class="n">Rm</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rp</span><span class="o">-</span><span class="n">Rm</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Rp</span><span class="o">+</span><span class="n">Rm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dRp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dRm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Qp</span><span class="p">,</span><span class="n">Qm</span><span class="p">,</span><span class="n">dRm</span><span class="p">)</span>
        <span class="n">dvsq</span> <span class="o">=</span> <span class="mf">4</span> <span class="o">*</span> <span class="p">((</span><span class="n">Rp</span><span class="o">*</span><span class="n">dRm</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Rm</span><span class="o">*</span><span class="n">dRp</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Rp</span><span class="o">+</span><span class="n">Rm</span><span class="p">)</span><span class="o">**</span><span class="mf">4</span>
        <span class="n">dvsq</span><span class="p">[</span><span class="n">dvsq</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0</span>
        <span class="k">return</span> <span class="n">Qp</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dvsq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Qp</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="PolarizedNeutronQProbe"><a class="viewcode-back" href="../../api/probe.html#refl1d.probe.PolarizedNeutronQProbe">[docs]</a><span class="k">class</span> <span class="nc">PolarizedNeutronQProbe</span><span class="p">(</span><span class="n">PolarizedNeutronProbe</span><span class="p">):</span>
    <span class="n">polarized</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dQ</span> <span class="o">=</span> <span class="n">Qmeasurement_union</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2006-2011, Paul Kienzle, Nikunj Patel, James Krycka.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>